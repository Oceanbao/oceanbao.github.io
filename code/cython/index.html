<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<meta name="description" content="Ocean on GitHub.">

<meta name="twitter:card" content="summary">
<meta name="twitter:domain" content="https://oceanbao.github.io/">

<meta name="twitter:image" content="https://oceanbao.github.io/tn.png">
<meta name="twitter:title" property="og:title" itemprop="title name" content="Ocean Ode">
<meta name="twitter:description" property="og:description" itemprop="description" content="Ocean on GitHub.">
<meta name="og:type" content="website">
<meta name="og:url" content="https://oceanbao.github.io/">
<meta name="og:image" itemprop="image primaryImageOfPage" content="https://oceanbao.github.io/tn.png">

<link rel="shortcut icon" href="https://oceanbao.github.io/oceanicon.jpg" id="favicon">
<link rel="stylesheet" href="https://oceanbao.github.io/css/style.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">


    

    
    
    
    <title>
        
        Cython
        
    </title>
</head>

<body>

    <div class="wrap">
        <div class="section" id="title">Cython</div>
        <aside>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#standard---distutils--cythonize">STANDARD - DISTUTILS + CYTHONIZE</a></li>
    <li><a href="#interactive-ipython-cython-magic">Interactive IPython %%cython magic</a></li>
    <li><a href="#compiling-on-the-fly-with-pyximport">Compiling On-the-Fly with pyximport</a>
      <ul>
        <li><a href="#controlling-and-managing-depens">Controlling and Managing Depens</a></li>
        <li><a href="#example-with-external-depens">Example with External Depens</a></li>
      </ul>
    </li>
    <li><a href="#rolling-own-and-compiling-by-hand">Rolling Own and Compiling by Hand</a></li>
    <li><a href="#other-build-systems">Other Build Systems</a>
      <ul>
        <li><a href="#cmake">CMake</a></li>
        <li><a href="#make">Make</a></li>
      </ul>
    </li>
    <li><a href="#standalone-executables">Standalone Executables</a></li>
    <li><a href="#compiler-directives">Compiler Directives</a></li>
  </ul>

  <ul>
    <li><a href="#the-why">The WHY</a>
      <ul>
        <li><a href="#interpreted-vs-compiled-execution">Interpreted vs. Compiled Execution</a></li>
        <li><a href="#dynamic-vs-static-typing">Dynamic vs. Static Typing</a></li>
      </ul>
    </li>
    <li><a href="#st-declaration">ST Declaration</a>
      <ul>
        <li><a href="#c-pointers">C Pointers</a></li>
        <li><a href="#mixing-st-and-dt-power-of-cython">Mixing ST and DT (Power of Cython)</a></li>
      </ul>
    </li>
    <li><a href="#st-with-python-type">ST with Python Type!</a>
      <ul>
        <li><a href="#st-for-speed">ST for Speed</a></li>
        <li><a href="#reference-counting-and-static-string-types">Reference Counting and Static String Types</a></li>
      </ul>
    </li>
    <li><a href="#cythons-3-kinds-of-func">Cython's 3 kinds of FUNC</a>
      <ul>
        <li><a href="#python-func-with-def">Python func with def</a></li>
        <li><a href="#c-funcs-with-cdef">C Funcs with cdef</a></li>
        <li><a href="#combining-as-cpdef">Combining as cpdef</a></li>
        <li><a href="#exception-handling">Exception Handling</a></li>
        <li><a href="#embedsignature-compiler-directive">Embedsignature Compiler Directive</a></li>
      </ul>
    </li>
    <li><a href="#type-coercion-and-casting">Type Coercion and Casting</a></li>
    <li><a href="#structs-unions-enums">Structs, Unions, Enums</a>
      <ul>
        <li><a href="#type-aliasing-with-ctypedef">Type Aliasing with ctypedef</a></li>
      </ul>
    </li>
    <li><a href="#loop-and-while">Loop and While</a>
      <ul>
        <li><a href="#guidelines-for-efficient-loops">Guidelines for Efficient Loops</a></li>
      </ul>
    </li>
    <li><a href="#cython-preprocessor-c-macro">Cython Preprocessor (C macro)</a></li>
  </ul>

  <ul>
    <li><a href="#python-data-structure-and-organisation">Python Data Structure and Organisation</a></li>
    <li><a href="#converting-python-data-to-structs">Converting Python Data to structs</a>
      <ul>
        <li><a href="#running-cythonized-version">Running Cythonized version</a></li>
      </ul>
    </li>
    <li><a href="#conversion-summary">Conversion Summary</a></li>
    <li><a href="#detail-code-study">Detail Code Study</a></li>
  </ul>

  <ul>
    <li><a href="#comparing-py-class-and-ext-type">Comparing Py-Class and Ext Type</a></li>
    <li><a href="#type-attributes-and-access-control">Type Attributes and Access Control</a></li>
    <li><a href="#c-level-init-and-final">C-Level INIT and FINAL</a></li>
    <li><a href="#cdef-and-cpdef-methods">cdef and cpdef Methods</a></li>
    <li><a href="#inheritance-and-subclassing">Inheritance and Subclassing</a></li>
    <li><a href="#casting-and-subclass">Casting and Subclass</a></li>
    <li><a href="#extension-type-objects-and-none">Extension Type Objects and None</a></li>
    <li><a href="#extension-type-properties">Extension Type Properties</a></li>
    <li><a href="#special-methods-are-even-more-special">Special Methods Are Even More SPECIAL</a>
      <ul>
        <li><a href="#arithmetic">Arithmetic</a></li>
        <li><a href="#rich-comparisons">Rich Comparisons</a></li>
        <li><a href="#iterator">Iterator</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#declaration-file">Declaration File</a>
      <ul>
        <li><a href="#declarations-and-definitions">Declarations and Definitions</a></li>
      </ul>
    </li>
    <li><a href="#cimport-statement">cimport Statement</a></li>
    <li><a href="#predefined-definition-files">Predefined Definition Files</a>
      <ul>
        <li><a href="#using-cimport-with-a-module-in-a-package">Using cimport with a module in a package</a></li>
      </ul>
    </li>
    <li><a href="#include-files-and-include-statement">Include Files and Include Statement</a></li>
    <li><a href="#organising-and-compiling-cython-modules-inside-python-packages">Organising and Compiling Cython Modules Inside Python Packages</a></li>
  </ul>

  <ul>
    <li><a href="#declaring-external-c-code-in-cython">Declaring External C code in Cython</a></li>
    <li><a href="#cython-does-not-automate-wrapping">Cython Does NOT Automate Wrapping</a></li>
    <li><a href="#declaring-external-c-func-and-typedefs">Declaring External C Func and typedefs</a></li>
    <li><a href="#declaring-and-wrapping-c-structs-unions-enums">Declaring and Wrapping C structs, unions, enums</a></li>
    <li><a href="#wrapping-c-functions">Wrapping C Functions</a></li>
    <li><a href="#wrapping-c-structs-with-extension-types">Wrapping C structs with Extension Types</a></li>
    <li><a href="#more-control---constant-modifier-output">More Control - constant, modifier, output</a></li>
    <li><a href="#error-exception---callback">Error Exception - Callback</a>
      <ul>
        <li><a href="#callbacks-and-exception-propagation">Callbacks and Exception Propagation</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </aside>
        <div class="section" id="content"><h1 id="cython-book">Cython Book</h1>
<p>Cython depends on CPython implementation (C/Python Interface)</p>
<p>[toc]</p>
<h1 id="chapter-1">Chapter 1</h1>
<p>EXAMPLE COMPARED (code)</p>
<blockquote>
<p>WHY FASTER: function call overhead, looping, math ops, stack versus heap memory allocation.</p>
</blockquote>
<blockquote>
<p>Dynamic Lookup: all runtime definitions and object constructions -&gt; Python interpreter checks types of object and find dunders -&gt; unboxing objects to extract the underlying C types, and only THEN can the ops occur! C and Cython already compiled types, the addition compiles to one machine code instruction.</p>
</blockquote>
<p><strong>Cython Wrapping C</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// cfib.h
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">cfib</span>(<span style="color:#66d9ef">int</span> n);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># Cython wrapper</span>

<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">cfib.h</span><span style="color:#e6db74">&#34;</span>:
    double cfib(int n)
    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fib</span>(n):
    <span style="color:#e6db74">&#34;&#34;&#34;Returns the nth Fib&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> cfib(n)
</code></pre></div><ul>
<li><code>cdef extern</code> block uses header file and declare function's signature in the block's indented body; after it defines Python wrapper func calling C func and returning its result.</li>
<li>Compile Cython code into ext module <code>wrap_fib</code> and use it in Python</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> wrap_fib <span style="color:#f92672">import</span> fib
help(fib)
fib(<span style="color:#ae81ff">90</span>)
</code></pre></div><h1 id="chapter-2-compiling-and-running-cython-code">Chapter 2: Compiling and Running Cython Code</h1>
<p><strong>Ways of Compilation</strong></p>
<ul>
<li>Interactively from IPython interpreter</li>
<li>Compiled automatically at IMPORT time</li>
<li>Separately compiled by build tools like <code>distutils</code></li>
<li>Integrated into standard build system such as <code>make, CMake</code> etc</li>
</ul>
<p><strong>The Pipeline</strong></p>
<p>First - cython compiler transforms Cython source into optimised and platform-independent C or C++ !!</p>
<p>Second - compile the C/C++ source into SHARED LIB with a standard C/C++ compiler (platform dependent!!) <code>.so</code> file on Linux or MacOS and dynamic lib <code>.pyd</code> on Windows !!</p>
<blockquote>
<p>Flags passed to C/C++ compiler ensure this shared lib a full-fledged Python module - EXTENSION MODULE importable as if pure Python</p>
</blockquote>
<blockquote>
<p>Cython compiler a source-to-source compiler with highly optimised code</p>
</blockquote>
<blockquote>
<p>Once having C compiler and cython compiler (pip install cython) in place, ready to follow along with <code>distutils</code> and <code>pyximport</code> methods</p>
</blockquote>
<h2 id="standard---distutils--cythonize">STANDARD - DISTUTILS + CYTHONIZE</h2>
<p>One of many features of <code>distutils</code> is its ability to compile C source into an extension module, the SECOND stage in the pipeline. It manages ALL platform, architecture, and Python-version details !!</p>
<p>FIRST stage is handled by <code>cythonize</code> cmd, compiling Cython source (options) into C/C++ source file !!</p>
<p>EXPLICIT control the pipeline requiring writing small Python script and run it.</p>
<p><strong>distutils script</strong></p>
<ul>
<li>
<p><code>fib.pyx</code> used by <code>distutils</code> to create a compiled ext-mod <code>fib.so</code> on MacOS/Linux</p>
</li>
<li>
<p>control state via Python script named <code>setup.py</code></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># setup.py</span>
<span style="color:#f92672">from</span> distutils.core <span style="color:#f92672">import</span> setup
<span style="color:#f92672">from</span> Cython.Build <span style="color:#f92672">import</span> cythonize
  
setup(ext_modules<span style="color:#f92672">=</span>cythonize(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">fib.pyx</span><span style="color:#e6db74">&#39;</span>))
</code></pre></div></li>
<li>
<p><code>cythonize</code> the simplest call to convert Cython to C code by cython compiler (any file(s) is arg)</p>
</li>
<li>
<p><code>python setup.py build_ext --inplace</code></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ python setup.py build_ext -i
Compiling ...
Cythonizing fib.pyx
running build_ext
building <span style="color:#e6db74">&#39;fib&#39;</span> extension
creating build
creating build/temp.macosx-10.4-x86_64-2.7
gcc -fno-strict-aliasing -fno-common -dynamic -g -02
  -DNDEBUG -g -fwrapv -03 -Wall -Wstrict-prototypes
  -I/Users/ksmith/Devel/PY64/Python.framework/Versions/2.7/include/python2.7
  -c fib.c -o build/temp.macosx-10.4-x86_64-2.7/fib.o
gcc -bundle -undefined dynamic_lookup
  build/temp.macosx-10.4-x86_64-2.7/fib.o
  -o /Users/ksmith/fib.so
</code></pre></div><ul>
<li>first gcc call convert C code into an object file <code>fib.o</code></li>
<li>second gcc convert object file into Python ext-mod <code>fib.so</code></li>
<li>output: <code>fib.c</code>, <code>fib.so</code>, <code>build/</code> with intermediate build products</li>
</ul>
</li>
</ul>
<p><strong>Using Ext-Mod</strong></p>
<ul>
<li>
<p>Platform-agnostic, once compiled into ext-mod, the Python interpreter can  use</p>
</li>
<li>
<p><code>import fib</code> and <code>fib.fib?</code> shows fib as <code>builtin_function_or_method</code> indicating compiled code rather than straight Python</p>
</li>
<li>
<p>When using Cython to wrap C code, must include other source files in the compilation step</p>
</li>
<li>
<p>e.g compiling <code>cfib.c</code></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># setup_wrap.py</span>
<span style="color:#75715e"># skipping same two imports</span>
  
<span style="color:#75715e"># First create an Ext object with right name and sources</span>
ext <span style="color:#f92672">=</span> Extension(name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">wrap_fib</span><span style="color:#e6db74">&#39;</span>, sources<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">cfib.c</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">wrap_fib.pyx</span><span style="color:#e6db74">&#39;</span>])
  
<span style="color:#75715e"># Use cythonize on the ext object</span>
setup(ext_modules<span style="color:#f92672">=</span>cythonize(ext))
</code></pre></div><ul>
<li>extra step adding all required C and Cython sources</li>
</ul>
</li>
<li>
<p>if passing precompiled dynamic lib <code>libfib.so</code></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># skip two imports</span>
  
ext <span style="color:#f92672">=</span> Extension(name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">wrap_fib</span><span style="color:#e6db74">&#34;</span>,
                sources<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">wrap_fib.pyx</span><span style="color:#e6db74">&#34;</span>],
                library_dirs<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/path/to/libfib.so</span><span style="color:#e6db74">&#34;</span>],
                libraries<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">fib</span><span style="color:#e6db74">&#34;</span>])
  
setup(<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)
</code></pre></div><ul>
<li>naming only <code>wrap_fib.pyx</code> in the sources arg list and adding two more args to Ext object</li>
</ul>
</li>
</ul>
<h2 id="interactive-ipython-cython-magic">Interactive IPython %%cython magic</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">%</span><span style="color:#f92672">%</span>load_ext cythonmagic

<span style="color:#f92672">%</span><span style="color:#f92672">%</span>cython
def<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div><ul>
<li>generated files in <code>~/.ipython/cython</code></li>
</ul>
<h2 id="compiling-on-the-fly-with-pyximport">Compiling On-the-Fly with pyximport</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pyximport
pyximport<span style="color:#f92672">.</span>install()

<span style="color:#f92672">import</span> fib
fib<span style="color:#f92672">.</span>__file__ <span style="color:#75715e"># .../.pyxbld/lib.macos-...</span>
</code></pre></div><ul>
<li>simple case is fine, no more setup.py</li>
</ul>
<h3 id="controlling-and-managing-depens">Controlling and Managing Depens</h3>
<ul>
<li><code>.pyxdeps</code> to control depens of main pyx files</li>
<li><code>.pyxbld</code> to customise pyximport for diff uses
<ul>
<li><code>make_ext(modname, pyxfilename)</code> - if defined, called with two str args returning <code>distutils.extension.Extension</code> instance or result of <code>Cython.Build.cythonize</code>, allowing user to customise Ext by adding files to sources</li>
<li><code>make_setup_args</code> - if defined, pyximport calls this func with no arg to get extra arg-dcit to <code>distutils.core.setup</code></li>
</ul>
</li>
</ul>
<h3 id="example-with-external-depens">Example with External Depens</h3>
<ul>
<li>
<p>e.g. wrap fib in C, two C files - <code>_fib.h, _fib.c</code></p>
</li>
<li>
<p><code>cdef extern from  &quot;_fib.h&quot;</code> in <code>fib.pyx</code> and a minimal wrapper call C</p>
</li>
<li>
<p>config by creating <code>fib.pyxdeps</code> having one line: <code>_fib.*</code></p>
<ul>
<li>This glob pattern match both C files, so pyximport will recompile <code>fib.pyx</code> whenever whichever changes</li>
</ul>
</li>
<li>
<p>instruct compile and link C by <code>fib.pyxbld</code></p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_ext</span>(modname, pyxfilename):
    <span style="color:#f92672">from</span> distutils.extension <span style="color:#f92672">import</span> Extension
    <span style="color:#66d9ef">return</span> Extension(modname,
                    sources<span style="color:#f92672">=</span>[pyxfilename, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_fib.c</span><span style="color:#e6db74">&#39;</span>],
                     include_dirs<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">.</span><span style="color:#e6db74">&#39;</span>])
</code></pre></div></li>
<li>
<p>key line is sources=[] telling distutils to compile C file and link all together</p>
</li>
<li>
<p>now whichever changes next interpreter session will mod</p>
</li>
</ul>
</li>
</ul>
<h2 id="rolling-own-and-compiling-by-hand">Rolling Own and Compiling by Hand</h2>
<p>For the sake of completeness, from pyx source to end</p>
<ul>
<li>from Cython to C
<ul>
<li><code>cython fib.pyx</code></li>
</ul>
</li>
<li>most common args to above:
<ul>
<li>&ndash;cplus, -a, -2/-3</li>
</ul>
</li>
<li>from C to ext_mod:
<ul>
<li>C to object file with proper incl and flags</li>
<li><code>.o</code> to dynamic lib with right linking flags</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">CFLAGS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>python-config --cflags<span style="color:#66d9ef">)</span>
LDFLAGS<span style="color:#f92672">=</span><span style="color:#75715e">#(python-config --ldflags)</span>
cython fib.pyx <span style="color:#75715e"># --&gt; fib.c</span>
gcc -c fib.c <span style="color:#e6db74">${</span>CFLAGS<span style="color:#e6db74">}</span> <span style="color:#75715e"># --&gt; fib.o</span>
gcc fib.o -o fib.so -shared <span style="color:#e6db74">${</span>LDFLAGS<span style="color:#e6db74">}</span> <span style="color:#75715e"># --&gt; fib.so</span>
</code></pre></div><ul>
<li><code>-shared</code> tells gcc to create a shared library, MUST for MACOS</li>
<li>Strongly recomm using the same compiler that was used to compile the Python interpreter !!!</li>
<li><code>python-config</code> gives such tailored compiler/Python version combo</li>
</ul>
<h2 id="other-build-systems">Other Build Systems</h2>
<p>Many build tools better than distutils for depens management.</p>
<h3 id="cmake">CMake</h3>
<p>folding Cython to standard CMake-compiled project.</p>
<h3 id="make">Make</h3>
<p>Recomm to query Python interpreter to find right config/flags per above. (same as distutils.sysconfig)</p>
<ul>
<li>access <code>include</code> dir for <code>Python.h</code> where the Python/C API declared,
<ul>
<li><code>INCDIR := $(shell python -c &quot;from distutils import sysconfig; print(sysconfig.get_python_inc())&quot;)</code></li>
</ul>
</li>
<li>acquire Python dynamic libraries to link against
<ul>
<li><code>LIBS := $(shell python -c &quot;from distutils import sysconfig; print(sysconfig.get_config_var('LIBS'))&quot;)</code></li>
</ul>
</li>
</ul>
<p>Other config available via <code>get_config_var</code></p>
<h2 id="standalone-executables">Standalone Executables</h2>
<ul>
<li>nearly always compiled into dynamic lib and imported</li>
<li>BUT compiler does have optional embedding Python Interpreter inside main</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># irrationals.py</span>

<span style="color:#f92672">from</span> math <span style="color:#f92672">import</span> pi, e

<span style="color:#66d9ef">print</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div><ul>
<li><code>cython --embed irrationals.py</code>
<ul>
<li>&ndash;&gt; <code>irrational.c</code> with <code>main</code> entry point embedding Python interpreter</li>
</ul>
</li>
<li>compile it on MACOS or Linux
<ul>
<li><code>gcc $(python-config --cflags) $(python-config --ldflags) ./irrationals.c</code></li>
<li>&ndash;&gt; <code>a.out</code> executable</li>
<li><code>./a.out</code></li>
</ul>
</li>
</ul>
<h2 id="compiler-directives">Compiler Directives</h2>
<p>Comments inside code to control compilation configs. Four scopes in total.</p>
<ul>
<li>
<p>All can be set globally for an ext_module inside a <code>directive comment</code> must be atop before code</p>
</li>
<li>
<p>e.g. <code>nonecheck</code> would be <code># cython: nonecheck=True</code></p>
</li>
<li>
<p>e.g. turn off bounds checking for indexing <code># cython: nonecheck=True, boundscheck=False</code> or separate lines</p>
</li>
<li>
<p>CLI setting using <code>-X</code> or <code>-directive</code> OVERRIDING COMMENT SETTING</p>
<ul>
<li><code>cython --directive nonecheck=False source.pyx</code></li>
</ul>
</li>
<li>
<p>Some directives support func-context scope control via decorator and ctx-mnger:</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cimport cython
    
<span style="color:#a6e22e">@cython.boundscheck</span>(False)
<span style="color:#a6e22e">@cython.wraparound</span>(False)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fast_indexing</span>():
    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>Even more local control with context manager</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cimport cython
    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fast_indexing</span>(a):
    <span style="color:#66d9ef">with</span> cython<span style="color:#f92672">.</span>boundscheck(False), cython<span style="color:#f92672">.</span>wraparound(False):
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(a)):
            sum <span style="color:#f92672">+</span><span style="color:#f92672">=</span> a[i]
</code></pre></div></li>
<li>
<p>Neither of above two directives is affected by comment or CLI setting</p>
</li>
</ul>
</li>
</ul>
<h1 id="chapter-3-cython-in-depth">Chapter 3: Cython in Depth</h1>
<p><strong>WHY: RUNTIME INTERPRETATION VS. PRE-COMPILATION, &amp; DYNAMIC VS. STATIC TYPING</strong></p>
<h2 id="the-why">The WHY</h2>
<h3 id="interpreted-vs-compiled-execution">Interpreted vs. Compiled Execution</h3>
<ul>
<li>Before running, Python code auto-compiled to Python <strong>bytecode</strong>, a fundamental instructions to be executed  or <strong>interpreted</strong> by Python <strong>VM</strong></li>
<li>Since <em>VM</em> abstracts away all platform-specific details, Python bytecode can be generated anywhere, up to the VM to translate each high-level bytecode into one or more lower-level ops on OS, and ultimately the CPU.</li>
<li>C has no VM or interpreter, no high-level bytecodes; C code is translated, or <strong>compiled</strong>, directly to <strong>machine code</strong> by a compiler - output executable/compiled-lib platform-architecture specific, directly run by CPU, as low-level as it gets.</li>
<li>Bridging bytecode-VM and machinecode-executing CPU: Python interpreter can run compiled C code directly and transparently to the end user - must be a specific kind of dynamic library aka <strong>extension module</strong> - full-fledged Python modules but inside precompiled machine-code
<ul>
<li>Python VM no longer interprets bytecodes but runs machine-code directly - removing overhead</li>
</ul>
</li>
<li>Cython + C compiler convert Cython source code into compiled platform-specific extension module</li>
<li>Usually 10-30 x faster just converting from Python code into an equivalent extension module</li>
<li>BUT real speed comes from replacing Python's dynamic dispatch with static typing</li>
</ul>
<h3 id="dynamic-vs-static-typing">Dynamic vs. Static Typing</h3>
<ul>
<li>
<p>ST requires the <strong>type of a variable be fixed at compile time</strong></p>
</li>
<li>
<p>Why fast: <strong>besides compile-time type checking</strong>, compilers use static typing to <strong>generate fast machine code tailored to that specific type</strong>!</p>
</li>
<li>
<p>DT has no restrictions on type, interpreter spends most time figuring out what <strong>low-level ops to run</strong>, and <strong>extracting the data to give to this low-level ops</strong></p>
</li>
<li>
<p>Python particularly flexible, a variable can be any type at any time - <em>dynamic dispatch</em></p>
</li>
<li>
<p>Example: <code>a + b</code></p>
<ul>
<li>interpreter inspects the Python object referred to by <code>a</code> for its type, requiring at least one pointer lookup at C level</li>
<li>interpreter asks the type for an implementation of the addition method, may requiring one or more pointer lookups and internal func calls</li>
<li>if method found, interpreter has an actual func it can call, implemented either in Python or C</li>
<li>interpreter calls the addition func and passes <code>a, b</code> as args</li>
<li>addition func extractions the necessary internal data from <code>a, b</code>, may requiring several more pointer lookups and conversions from Python types to C types - if ok, only then can it run actual ops adding</li>
<li>result then must be placed inside a (perhaps new) Python object and returned</li>
</ul>
</li>
<li>
<p>C compiler knows at compile time what low-level ops to run and what low-level data as args; at runtime, compiled C program skips nearly ALL steps - for numeric types math ops, compiler generates machine-code to load data into <strong>registers, add them, store the result</strong></p>
</li>
</ul>
<h2 id="st-declaration">ST Declaration</h2>
<ul>
<li>
<p>DT variables in Cython come for free: simply assign as Python</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cdef int i
cdef int j
cdef float k
  
j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
i <span style="color:#f92672">=</span> j
k <span style="color:#f92672">=</span> <span style="color:#ae81ff">12.0</span>
j <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> k
<span style="color:#66d9ef">assert</span> i <span style="color:#f92672">!=</span> j
</code></pre></div></li>
<li>
<p><strong>these ST vars have C semantics, which changes the behaviour of assignment and follow C coercion and casting rules</strong>!</p>
</li>
<li>
<p><code>i = j</code> copies the int data at <code>j</code> to the mem_loc reserved for <code>i</code> - <code>i</code> and <code>j</code> refer to independent entities, and can evolve separately</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">integrate</span>(a, b, f):
    cdef int i
    cdef int N<span style="color:#f92672">=</span><span style="color:#ae81ff">2000</span>
    cdef float dx, s<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>
    dx <span style="color:#f92672">=</span> (b<span style="color:#f92672">-</span>a)<span style="color:#f92672">/</span>N
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(N):
        s <span style="color:#f92672">+</span><span style="color:#f92672">=</span> f(a<span style="color:#f92672">+</span>i<span style="color:#f92672">*</span>dx)
    <span style="color:#66d9ef">return</span> s <span style="color:#f92672">*</span> dx
  
<span style="color:#75715e"># or </span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">integrate</span>(a, b, f):
    cdef:
        int i
        int N<span style="color:#f92672">=</span><span style="color:#ae81ff">2000</span>
        float dx, s<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>
        <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div></li>
<li>
<p><strong>NOTE: C static used to declare var whose lifetime extends to the entire lifetime of a program, invalid Cython key; C const declares an unmodifiable identifier, which Cython supports</strong></p>
</li>
<li>
<p>Common cdef</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">C</span> <span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">p</span><span style="color:#960050;background-color:#1e0010">e</span>					<span style="color:#960050;background-color:#1e0010">C</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">n</span> <span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span>
  
<span style="color:#960050;background-color:#1e0010">P</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">s</span>				<span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span> <span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span> <span style="color:#960050;background-color:#1e0010">*</span><span style="color:#960050;background-color:#1e0010">p</span>
                      <span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span> <span style="color:#960050;background-color:#1e0010">v</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">d</span> <span style="color:#960050;background-color:#1e0010">*</span><span style="color:#960050;background-color:#1e0010">*</span><span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">f</span>
<span style="color:#960050;background-color:#1e0010">S</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">k</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">c</span> <span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">s</span>		<span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span> <span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span> <span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">r</span>[<span style="color:#ae81ff">10</span>]
                      <span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span> <span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">e</span> <span style="color:#960050;background-color:#1e0010">p</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">s</span>[<span style="color:#ae81ff">20</span>][<span style="color:#ae81ff">30</span>]
<span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">p</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span> <span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">s</span>			<span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span> <span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">z</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">_</span><span style="color:#960050;background-color:#1e0010">t</span> <span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">n</span>
<span style="color:#960050;background-color:#1e0010">C</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">m</span><span style="color:#960050;background-color:#1e0010">p</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">d</span> <span style="color:#960050;background-color:#1e0010">(</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">)</span>	<span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span> <span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">m</span> <span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">m</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">_</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">t</span>
                          <span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span> <span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">_</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">_</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">n</span> <span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">_</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">_</span><span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">s</span>
<span style="color:#960050;background-color:#1e0010">F</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">c</span> <span style="color:#960050;background-color:#1e0010">P</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">s</span>			<span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">f</span> <span style="color:#960050;background-color:#1e0010">v</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">d</span> <span style="color:#960050;background-color:#1e0010">(</span><span style="color:#960050;background-color:#1e0010">*</span><span style="color:#960050;background-color:#1e0010">f</span><span style="color:#960050;background-color:#1e0010">)</span><span style="color:#960050;background-color:#1e0010">(</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">)</span>
</code></pre></div></li>
<li>
<p>tongue twisters: <strong>func one args as func pointers returns another func pointer</strong></p>
<ul>
<li><code>cdef int (*signal)(int (*f)(int))(int)</code></li>
</ul>
</li>
<li>
<p>Cython <strong>auto-infer types WHEN semantics cannot be changed</strong> (int would not be typed as C long)</p>
<ul>
<li>
<p><code>infer_types</code> directive giving Cython more leeway to infer</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cimport</span> cython
    
<span style="color:#a6e22e">@cython</span><span style="color:#f92672">.</span>infer_types(True)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">more_inference</span>():
    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    d <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.0</span>
    c <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>j
    r <span style="color:#f92672">=</span> i <span style="color:#f92672">*</span> d <span style="color:#f92672">+</span> c
    <span style="color:#66d9ef">return</span> r
</code></pre></div></li>
<li>
<p>here <code>i</code> is typed as C long, d as double - enabling this directives put responsibility to coder to ensure that int ops <strong>do not overflow and constant semantics</strong></p>
</li>
<li>
<p>useful to set globally <strong>to test performance difference</strong>!</p>
</li>
</ul>
</li>
</ul>
<h3 id="c-pointers">C Pointers</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> *<span style="color:#a6e22e">p_int</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">float</span>** <span style="color:#a6e22e">pp_float</span> <span style="color:#f92672">=</span> NULL

<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> *<span style="color:#a6e22e">a</span>, *<span style="color:#a6e22e">b</span>
</code></pre></div><ul>
<li>
<p>as with C, asterisk can be declared adjacent to the type or to the variable, though <strong>pointerness is linked with variable, not the type</strong></p>
</li>
<li>
<p>Dereferencing pointers is different! Since Python already uses <code>*args, **kwargs</code>, Cython <strong>does not support <code>*a</code> syntax to dereference a C pointer</strong>, instead <strong>index into the pointer at location 0</strong> to dereference a pointer in Cython!!</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># e.g. two pointers</span>
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">golden_ratio</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">double</span> *<span style="color:#a6e22e">p_double</span>
  
<span style="color:#75715e"># assign golden_ratio ADDR to p_double using ADDR-OF operator &amp;</span>
p_double <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>golden_ratio
  
<span style="color:#75715e"># assign to golden_ratio via p_double using indexing-at-zero-to-dereference </span>
p_double[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.618</span> <span style="color:#75715e"># *p_double in C to dereference</span>
<span style="color:#66d9ef">print</span> golden_ratio <span style="color:#75715e"># =&gt; 1.618</span>
  
<span style="color:#75715e"># access p_double&#39;s REFERENT the same</span>
<span style="color:#66d9ef">print</span> p_double[<span style="color:#ae81ff">0</span>] <span style="color:#75715e"># =&gt; 1.618</span>
</code></pre></div></li>
<li>
<p>Another difference arises <strong>when using pointers to STRUCT</strong></p>
<ul>
<li>
<p>in C if <code>p_st</code> pointer to struct <code>typedef</code>: <code>st_t *p_st = make_struct()</code></p>
</li>
<li>
<p>then to access a struct member using arrow <code>int a_doubled = p_st-&gt;a + p_st-&gt;a;</code></p>
</li>
<li>
<p>Cython always uses dot access nonpointer struct or not</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">st_t</span> *<span style="color:#a6e22e">p_st</span> <span style="color:#f92672">=</span> make_struct()
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">a_doubled</span> <span style="color:#f92672">=</span> p_st<span style="color:#f92672">.</span>a <span style="color:#f92672">+</span> p_st<span style="color:#f92672">.</span>a
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="mixing-st-and-dt-power-of-cython">Mixing ST and DT (Power of Cython)</h3>
<ul>
<li>
<p>e.g. several C ints grouping into a dynamic Python tuple</p>
<ul>
<li>
<p>C code to create and init this tuple using Python/C API is tedious, which in Cython:</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">c</span>
<span style="color:#75715e"># ...calcu </span>
tuple_of_ints <span style="color:#f92672">=</span> (a, b, c)
</code></pre></div></li>
<li>
<p><strong>This works BECAUSE of linkage between C ints and Python ints, NOT if they were C pointers, which would need dereferencing them BEFORE putting into tuple, or other ways</strong></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">P</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">n</span> <span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">p</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">s</span> 			<span style="color:#960050;background-color:#1e0010">C</span> <span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">p</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">s</span>
    
<span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">l</span>					<span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span>
<span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span>						[<span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">g</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">d</span>] <span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">r</span>
<span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">g</span>					[<span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">g</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">d</span>] <span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">t</span>
                        [<span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">g</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">d</span>] <span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">t</span>
                        [<span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">g</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">d</span>] <span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">g</span>
                        [<span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">g</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">d</span>] <span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">g</span> <span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">g</span>
<span style="color:#960050;background-color:#1e0010">f</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">t</span>					<span style="color:#960050;background-color:#1e0010">f</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">t</span>
                        <span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">e</span>
                        <span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">g</span> <span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">e</span>
<span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">m</span><span style="color:#960050;background-color:#1e0010">p</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">x</span>					<span style="color:#960050;background-color:#1e0010">f</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">t</span> <span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">m</span><span style="color:#960050;background-color:#1e0010">p</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">x</span>
                        <span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">e</span> <span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">m</span><span style="color:#960050;background-color:#1e0010">p</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">x</span>
<span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">s</span>					<span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">r</span> <span style="color:#960050;background-color:#1e0010">*</span>
<span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">r</span>						<span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">g</span> <span style="color:#960050;background-color:#1e0010">(</span><span style="color:#960050;background-color:#1e0010">C</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#960050;background-color:#1e0010">)</span>
<span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">e</span>
<span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">t</span>					<span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">r</span><span style="color:#960050;background-color:#1e0010">u</span><span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">t</span>
</code></pre></div></li>
<li>
<p><strong>bint</strong></p>
<ul>
<li>int at C level converted to and fro a Python bool</li>
</ul>
</li>
<li>
<p><strong>Integral type conversions and overflow</strong></p>
<ul>
<li>Python 3 all int are unlimited precision</li>
<li>C checks for overflow, raise OverflowError if cannot represent Python integer</li>
<li>Directives <code>overflowcheck</code> and <code>overflowcheck.fold</code> will catch overflow errors - set to True will raise error for overflowing C integer maths ops - may help remove some overhead when enabled</li>
</ul>
</li>
<li>
<p><strong>Floating-point</strong></p>
<ul>
<li>float is double, conversion may truncate to 0.0 or positive/negative infinity</li>
</ul>
</li>
<li>
<p><strong>str and unicode</strong></p>
<ul>
<li><code>c_string_type</code> and <code>c_string_encoding</code> directives need to be set to allow conversion</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="st-with-python-type">ST with Python Type!</h2>
<ul>
<li>
<p>possible for built-in and extension types like NumPy arrays and many others</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">list</span> <span style="color:#a6e22e">particles</span>, <span style="color:#a6e22e">mods</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">dict</span> <span style="color:#a6e22e">names_from_particles</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">str</span> <span style="color:#a6e22e">pname</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">set</span> <span style="color:#a6e22e">unique_particles</span>
</code></pre></div></li>
<li>
<p>Underneath, Cython <strong>declares them as C pointers to some built-in Python struct type, can be used as is but constrained to their declared type:</strong></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython">particles <span style="color:#f92672">=</span> list(names_from_particles<span style="color:#f92672">.</span>keys())
</code></pre></div></li>
<li>
<p>Dynamic variables can be init from ST</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython">other_particles <span style="color:#f92672">=</span> particles
<span style="color:#66d9ef">del</span> other_particles[<span style="color:#ae81ff">0</span>]
</code></pre></div></li>
<li>
<p><strong>Note: ST Python object is fixed, cannot be referring to any other Python type</strong></p>
</li>
<li>
<p>BEHAVIOUR</p>
<ul>
<li>add/sub/mul each has own behaviour: Python long coercion for large values and C overflow for limited-precision int</li>
<li>Div/Modulus <strong>markedly different modulus with signed int</strong>: <strong>C rounds towards 0 while Python rounds towards infinity</strong>
<ul>
<li><code>-1 % 5</code>  =&gt; 4 in Python and =&gt; -1 in C</li>
<li>Python raise ZeroDivisionError but C has NO SUCH FAILSAFE!</li>
</ul>
</li>
<li>Cython use Python semantics even when operands are ST C scalars, to turn off use <code># cython: cdivision=True</code> or <a href="mailto:%60@cython.cdivision">`@cython.cdivision</a>(True)<code>or</code>with cython.cdivision(True):` context manager</li>
<li><code>cdivision_warnings=True</code> directive emits runtime warning whenever division or modulo run on negative operands</li>
</ul>
</li>
</ul>
<h3 id="st-for-speed">ST for Speed</h3>
<ul>
<li>
<p>General principle: <em>the more static type info provided, the better Cython can optimize the result</em></p>
</li>
<li>
<p>e.g. Appending Particle object to a dynamic variable</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython">dynamic_particles <span style="color:#f92672">=</span> make_particles(<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)
<span style="color:#75715e">#...</span>
dynamic_particles<span style="color:#f92672">.</span>append(Particle())
<span style="color:#75715e">#...</span>
</code></pre></div><ul>
<li>
<p>cython compiler generate code handling any Python object and test at runtime if <code>dynamic_particles</code> is a <code>list</code>, else as long as <code>append</code> method taking args the code will run</p>
<ul>
<li>under, the code first looks up <code>append</code> attr using <code>PyObject_GetAttr</code> then calls it using the completely general <code>PyObject_Call</code> Python/C API - essentially what Python interpreter would do when running equivalent Python bytecode!</li>
</ul>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># static typing</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">list</span> <span style="color:#a6e22e">static_particles</span> <span style="color:#f92672">=</span> make_particles(<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>)
<span style="color:#75715e">#...</span>
static_particles<span style="color:#f92672">.</span>append(Particle())
<span style="color:#75715e">#...</span>
</code></pre></div></li>
<li>
<p>now Cython can generate specialised code directly calling either <code>PyList_SET_ITEM</code> or <code>PyList_Append</code> from the C API - this is what the above <code>PyObject_Call</code> ends up calling <em>anyway</em>, but ST allows Cython to remove dynamic dispatch on <code>static_particles</code></p>
</li>
</ul>
</li>
<li>
<p>currently supported built-in ST Python types</p>
<ul>
<li><code>type, object, bool, complex, basestring, str, unicode, bytes, bytearray, list, tuple, dict, set, frozenset, array, slice, date, time, datetime, timedelta,  tzinfo</code></li>
<li>For Python types with direct C types <code>int, long, float</code> turn out not easy, BUT the need to do so is rare - often simply declare regular C <code>int, long, float, double</code> and let Cython do auto-convert to and fro Python
<ul>
<li>Python <code>float</code> -&gt; C <code>double</code>, hence C <code>double</code> is preferred whenever conversions to and fro Python used to ensure <strong>no clipping of values or loss of precision</strong></li>
<li>Python 3 at C level, all integers are <code>PyLongObjects</code></li>
<li>Cython properly converts between C integral types and these Python types in a language-agnostic way, raising <code>OverflowError</code> when impossible</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="reference-counting-and-static-string-types">Reference Counting and Static String Types</h3>
<ul>
<li>
<p>One of Python's major features is <strong>auto MEM management</strong> - CPython uses plain <strong>reference counting</strong> with auto-GC runs periodically to clean up unreachable reference cycles!</p>
</li>
<li>
<p>Cython auto manage (ST or DT) Python object ensuring cleaning up</p>
</li>
<li>
<p>Implication in mixing types - if having two Python <code>bytes</code> objects <code>b1, b2</code> to extract underlying <code>char</code> pointer after adding:</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython">b1 <span style="color:#f92672">=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">All men are normal</span><span style="color:#e6db74">&#34;</span>
b2 <span style="color:#f92672">=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Socrates is a man</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">char</span> *<span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> b1 <span style="color:#f92672">+</span> b2
</code></pre></div></li>
<li>
<p><code>b1 + b2</code> is a temporary Python <code>bytes</code> object and the assigning attemps to extract its <code>char</code> pointer using Cython's auto-convert rules</p>
</li>
<li>
<p>Because the result of the addition is temporary object, the above code cannot work - temporary result of addition is <strong>deleted at once after created</strong>, Cython is able to catch the rror and issue compilation error</p>
</li>
<li>
<p>the correct way - use a temporary Python variable, either ST or DT</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># DT</span>
tmp <span style="color:#f92672">=</span> s1 <span style="color:#f92672">+</span> s2
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">char</span> *<span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> tmp
<span style="color:#75715e"># ST</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">bytes</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> s1 <span style="color:#f92672">+</span> s2
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">char</span> *<span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> tmp
</code></pre></div></li>
</ul>
</li>
<li>
<p>These cases uncommon, only due to C-level object is <strong>referring</strong> to data managed by Python object - since Python object owns the underlying string, the C <code>char *</code> buffer has no way to tell Python that it has another (non-Python) reference - creating temporary <code>bytes</code> so that Python does not delete the string data, must ensuring it is kept so long as the C <code>char *</code> buffer is required!</p>
</li>
<li>
<p><strong>The other C types (table above) are all value types, not pointer types - Python data is copied during assignment (C semantics) allowing C variable to evolve separately from Python object used to init it!</strong></p>
</li>
</ul>
</li>
</ul>
<h2 id="cythons-3-kinds-of-func">Cython's 3 kinds of FUNC</h2>
<ul>
<li>Much of above variable typing mix applies to functions in Cython.</li>
<li>Python function is <strong>first-class citizens</strong> - meaning they are objects with state and behaviour!
<ul>
<li>created both at import and dynamically at runtime</li>
<li>created anonymously with lambda</li>
<li>defined inside another func</li>
<li>returned from other func</li>
<li>passed as an arg to other func</li>
<li>called with positional and keyword args</li>
<li>defined with default values</li>
</ul>
</li>
<li>C func has minimal call overhead, orders of magnitude faster
<ul>
<li>can be passed as arg to other func (but doing so is much more cumbersome than in Python)</li>
<li>cannot be defined inside another</li>
<li>has statically assigned name unmodifiable</li>
<li>takes only positional arg</li>
<li>does not support default values for parameters</li>
</ul>
</li>
</ul>
<h3 id="python-func-with-def">Python func with def</h3>
<ul>
<li>
<p>regular Python func</p>
<ul>
<li>takes DT python object only</li>
<li>used the same way regardless how it's imported</li>
<li>compiled using any method, e.g. as <code>fact.pyx</code> with <code>import pyximport; pyximport.install(); import fact</code></li>
</ul>
</li>
<li>
<p>pure Python func compiled by Cython is faster somewhat, the source of speedup is the <strong>removal of interpretation overhead and the reduced function call overhead in Cython</strong></p>
</li>
<li>
<p>different implementation:</p>
<ul>
<li>Python func has type <code>function</code>, Cython has type <code>builtin_function_or_method</code></li>
<li>Python has several attributes available (<code>__name__</code> , etc) and modifiable, Cython unmodifiable</li>
<li><strong>Python execute bytecodes with Python interpreter, Cython runs compiled C code that calls into Python/C API, bypassing bytecode interpretation entirely!</strong></li>
</ul>
</li>
<li>
<p>One nice feature of Python <code>int</code> is that they can represent arbitrarily large values (to MEM), convenient but cost speed</p>
</li>
<li>
<p>Cython version with C <code>long</code> integral type is faster but with limited-precision possibly overflow!</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">typed_fact</span>(long n):
    <span style="color:#e6db74">&#34;&#34;&#34;Compute n!&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> n <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
   <span style="color:#66d9ef">return</span> n <span style="color:#f92672">*</span> typed_fact(n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</code></pre></div></li>
<li>
<p>As <code>n</code> is func arg, omitting <code>cdef</code></p>
</li>
<li>
<p>this code is no faster, since it's a Python func with Python return object - lots of code generated to extract the underlying C long from Python integer returned, ops and packing/unpacking essentially ends up the same code paths as pure</p>
</li>
</ul>
</li>
<li>
<p>Cython allows ST args to have default, as positional or keyword!</p>
</li>
<li>
<p>One way is to do recursive, but later. The idea is to let C do the hard work and trivially convert result to Python object- cdef</p>
</li>
</ul>
<h3 id="c-funcs-with-cdef">C Funcs with cdef</h3>
<ul>
<li>
<p><code>cdef</code> C-calling semantics taking and returning ST objects, work with C pointers, structs, other C types cannot be auto-coerced to Python types! (think <code>cdef</code> as C function defined with Cython's Python-like syntax)</p>
</li>
<li>
<p>Note: <strong>can declare and use Python objects, but <code>cdef</code> functions are typically used when needing to get close to C without writing C</strong></p>
</li>
<li>
<p>Mixing function types same as variable in the same source file - returning ST can be any of <code>pointers, structs, C array, static Python list, dict or void</code> or ommitted defaulted to <code>object</code></p>
</li>
<li>
<p><strong>Cython DOES NOT allow cdef to be called from external Python code</strong>, therefore they are typically used as fast auxiliary functions to help <code>def</code></p>
</li>
<li>
<p>using it outside the extension_module:</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># need minimal def calling it internally</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrap_c_fact</span>(n):
    <span style="color:#66d9ef">return</span> c_fact(n)
</code></pre></div></li>
<li>
<p>BUT: limited to C integral types only - depending on how large <code>unsigned long</code> is on OS</p>
<ul>
<li>one option to partially address this is to use <code>double</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="combining-as-cpdef">Combining as cpdef</h3>
<ul>
<li><strong>hybrid, getting C-only function and a Python wrapper for it, both with the same name</strong></li>
<li>calling it from Cython calls C-only version, and wrapper if called in Python</li>
<li><strong>inline</strong> key in C/C++ suggests to compiler to replace the so-delcared func with its body whevere it is called, thereby further removing call overhead <code>cdef inline long c_fact(long a):</code> , useful for small inlined func called in deeply nested loops !!!</li>
<li>LIMIT: its args must be compatible with both Python and C types - <strong>any Python object can be repr at C level (DT or ST built-in), but NOT ALL C types can be in Python</strong>, cannot use <code>void, pointer, array, etc</code> in <code>cpdef</code></li>
</ul>
<h3 id="exception-handling">Exception Handling</h3>
<ul>
<li>
<p><code>def</code> always returns some sort of <code>PyObject</code> pointer at C level - this invariant allows Cython to correctly propagate exceptions from <code>def</code> without issues</p>
</li>
<li>
<p><code>cdef, cpdef</code> may return non-Python type, making other tracing mechanism necessary</p>
</li>
<li>
<p>e.g. <code>ZeroDivisionErro</code> will be set but has no way for <code>cpdef</code> to communicate to caller</p>
</li>
<li>
<p>Cython <code>except</code></p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">divide_ints</span>(int i, int j) <span style="color:#66d9ef">except</span><span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
    <span style="color:#66d9ef">return</span> i <span style="color:#f92672">/</span> j
</code></pre></div></li>
<li>
<p><code>except? -1</code> returns <code>-1</code> to act as a possible sentinel for exception occurance (<code>-1</code> is arbitrary, any integer literal within the range of values for the return type is ok)</p>
</li>
<li>
<p><code>?</code> used here since <code>-1</code> might be a valid result, if any return value always indicates an error, it can be omitted; OR use <code>except *</code> to check regardless of return value but incur some overhead</p>
</li>
</ul>
</li>
</ul>
<h3 id="embedsignature-compiler-directive">Embedsignature Compiler Directive</h3>
<ul>
<li>Pure Python has introspection on signature <code>pure_func?</code> namely <em>definition</em></li>
<li>Cython func do have standard docstring but do not include a signature by default
<ul>
<li><code>embedsignature</code> directive set to True enable such</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>Generated C Code</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mult</span>(a, b):
    <span style="color:#66d9ef">return</span> a <span style="color:#f92672">*</span> b

<span style="color:#75715e"># compare with ST </span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>(int a, int b):
    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div><p><code>cython mult.pyx</code> =&gt; <code>mult.c</code></p>
<p>Several thousand lines long!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/* &#34;mult.pyx&#34;:3
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* def mult(a, b):
</span><span style="color:#75715e">*	return a * b 		# &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</span><span style="color:#75715e">*/</span>
__pyx_t_1 <span style="color:#f92672">=</span> PyNumer_Multiply(__pyx_v_a, __pyx_v_b);
<span style="color:#66d9ef">if</span> (unlikely(<span style="color:#f92672">!</span>__pyx_t_1)) {
    __pyx_filename <span style="color:#f92672">=</span> __pyx_f[<span style="color:#ae81ff">0</span>];
    __pyx_lineno <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
    __pyx_clineno <span style="color:#f92672">=</span> __LINE__;
    <span style="color:#66d9ef">goto</span> __pyx_l1_error;
}

<span style="color:#75715e">#</span><span style="color:#75715e"> compare with ST</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>...
    __pyx_t_1 <span style="color:#f92672">=</span> __Pyx_PyInt_From_int((__pyx_v_a <span style="color:#f92672">*</span> __pyx_v_b));
</code></pre></div></blockquote>
<h2 id="type-coercion-and-casting">Type Coercion and Casting</h2>
<ul>
<li>
<p>Both C and Python have well-defined coercion between numeric types</p>
</li>
<li>
<p>Explicit casting between types is common in C, esp. in pointers</p>
</li>
<li>
<p>Cython replaces parentheses with angle brackets</p>
</li>
<li>
<p><code>cdef int *ptr_i = &lt;int*&gt;v</code> ===&gt; <code>int *ptr_i = (int*)v'</code> in C</p>
</li>
<li>
<p>Explicit casting in C is not checked, given total control over to type</p>
<ul>
<li>
<p>e.g. emulating <code>id</code> function</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_addr</span>(a):
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">void</span> *<span style="color:#a6e22e">v</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>void<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>a
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">=</span> &lt;<span style="color:#66d9ef">long</span>&gt;v
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cython addr:</span><span style="color:#e6db74">&#34;</span>, addr)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Python id  :</span><span style="color:#e6db74">&#34;</span>, id(a))
        
        
<span style="color:#75715e"># use it</span>
<span style="color:#66d9ef">import</span> pyximport; pyximport<span style="color:#f92672">.</span>install()
    
<span style="color:#66d9ef">import</span> casting
    
casting<span style="color:#f92672">.</span>print_addr(<span style="color:#ae81ff">1</span>) <span style="color:#75715e"># same</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>Can casting with Python extension types, built-in or defined</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cast_to_list</span>(a):
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">list</span> <span style="color:#a6e22e">cast_list</span> <span style="color:#f92672">=</span> &lt;<span style="color:#66d9ef">list</span>&gt;a
    <span style="color:#66d9ef">print</span>(type(a))
    <span style="color:#66d9ef">print</span>(type(cast_list))
    cast_list<span style="color:#f92672">.</span>append(<span style="color:#ae81ff">1</span>)
</code></pre></div></li>
<li>
<p>it takes a Python object of any type and cast it to a static <code>list</code>!</p>
</li>
<li>
<p>Cython will treat <code>cast_list</code> as a list in C, calling either <code>PyList_SET_ITEM</code> or <code>PyList_Append</code> at last line</p>
</li>
<li>
<p>OK so long as the args is a <code>list</code> or a subtype, raising <code>SystemError</code> else</p>
</li>
<li>
<p><strong>such bare casts are appropriate only when we are certain that the object being cast has a compatible type</strong></p>
</li>
<li>
<p>when less certain let Cython let before casting</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">safe_cast_to_list</span>(a):
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">list</span> <span style="color:#a6e22e">cast_list</span> <span style="color:#f92672">=</span> &lt;<span style="color:#66d9ef">list?</span>&gt;a
    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div></li>
<li>
<p>raising <code>TypeError</code> when <code>a</code> is not <code>list</code> or subtype at casting</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Casting also comes into play when working with <strong>base and derived classes in extension type hierarchy</strong></p>
</li>
</ul>
<h2 id="structs-unions-enums">Structs, Unions, Enums</h2>
<ul>
<li>
<p>for <strong>un-typedef C struct or union declaration</strong></p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> mycpx {
    <span style="color:#66d9ef">int</span> a;
    <span style="color:#66d9ef">float</span> b;
};
    
<span style="color:#66d9ef">union</span> uu {
    <span style="color:#66d9ef">int</span> a;
    <span style="color:#66d9ef">short</span> b, c;
};
</code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># same in Cython</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">mycpx</span>:
    float real
    float imag
        
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">union</span> <span style="color:#a6e22e">uu</span>:
    int a
    short b, c
</code></pre></div></li>
<li>
<p>another case where Cython blends Python with C: using Python-like blocks to define C constructs!</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># combine both with ctypedef creating a new type alias for either</span>
<span style="color:#66d9ef">ctypedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">mycpx</span>:
    float real
    float imag
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
    
<span style="color:#75715e"># to declare a variable with the struct type, simply use cdef</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">mycpx</span> <span style="color:#a6e22e">zz</span>
    
<span style="color:#75715e"># init in 3 ways:</span>
    
<span style="color:#75715e"># 1: struct literals</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">mycpx</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> mycpx(<span style="color:#ae81ff">3.1415</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>)
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">mycpx</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> mycpx(real<span style="color:#f92672">=</span><span style="color:#ae81ff">2.718</span>, imag<span style="color:#f92672">=</span><span style="color:#ae81ff">1.618034</span>)
<span style="color:#75715e"># another blend of Python and C++ constructs</span>
    
<span style="color:#75715e"># 2: struct fields assignment</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">mycpx</span> <span style="color:#a6e22e">zz</span>
zz<span style="color:#f92672">.</span>real <span style="color:#f92672">=</span> <span style="color:#ae81ff">3.1415</span>
zz<span style="color:#f92672">.</span>imag <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>
<span style="color:#75715e"># for init, 1 is handy, but direct assign can be used to update field</span>
    
<span style="color:#75715e"># assigning from a Python dict</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">mycpx</span> <span style="color:#a6e22e">zz</span> <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">real</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">3.1415</span>, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">imag</span><span style="color:#e6db74">&#39;</span>: <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>}
<span style="color:#75715e"># this uses Cython&#39;s auto-convert to do each assign auto, but more overhead!!</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>Nested and anonymous inner struct/union ARE NOT SUPPORTED! Need to un-nest and provide dummy names:</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> nested {
    <span style="color:#66d9ef">int</span> outer_a;
    <span style="color:#66d9ef">struct</span> _inner {
        <span style="color:#66d9ef">int</span> inner_a;
    } inner;
};
</code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># cython</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_inner</span>:
    int inner_a
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">nested</span>:
    int outer_a
    _inner inner
        
<span style="color:#75715e"># can init nested on per-filed basis or assigning to a nested dictionary matching nested</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">nested</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">outer_a</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">inner</span><span style="color:#e6db74">&#39;</span>: {<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">inner_a</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">2</span>}}
</code></pre></div></li>
</ul>
</li>
<li>
<p><code>enum</code> defined by members on separate lines or comma-limited</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">PRIMARIES</span>:
    RED <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    YELLOW <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
    BLUE <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">SECONDARIES</span>:
    ORANGE, GREEN, PURPLE
</code></pre></div></li>
<li>
<p>can be declared either <code>ctypedef</code> or <code>cdef</code> as in struct/union</p>
</li>
<li>
<p>anonymous enums are useful to declare <strong>global integer constant</strong></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">enum</span>:
    GLOBAL_SEED <span style="color:#f92672">=</span> <span style="color:#ae81ff">37</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>struct/union/enum will be used more when interfacing with external code</p>
</li>
</ul>
<h3 id="type-aliasing-with-ctypedef">Type Aliasing with ctypedef</h3>
<ul>
<li>
<p>Another C feature is type aliasing with <code>ctypedef</code> used similarly as C's <code>typedef</code>, essential when interfacing with external code using <code>typedef</code> aliases</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">ctypedef</span> double real
<span style="color:#66d9ef">ctypedef</span> long integral
  
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">displacement</span>(real d0, real v0, real a, real t):
    <span style="color:#e6db74">&#34;&#34;&#34;Compute displacement under constant acceleration&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">real</span> <span style="color:#a6e22e">d</span> <span style="color:#f92672">=</span> d0 <span style="color:#f92672">+</span> (v0 <span style="color:#f92672">*</span> t) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> a <span style="color:#f92672">*</span> t<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>)
    <span style="color:#66d9ef">return</span> d
</code></pre></div><ul>
<li><code>ctypedef</code> aliases allow switching the precision of calcu from double precision to single precision by changing a single line of program - Cython auto-convert Python numeric types and these <code>ctypedef</code> aliase</li>
<li>more useful in C++ when <code>typedef</code> aliases can significantly shorten long templated types</li>
<li>must occur at file scope and CANNOT be used inside a function or other local scope</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>FUSED TYPES AND GENERIC CODING</strong></p>
<ul>
<li>
<p>Cython has novel typing <strong>fused types</strong> allowing reference to several reltaed types with a single type definition</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># max for integral values</span>
  
<span style="color:#66d9ef">from</span> cython <span style="color:#66d9ef">cimport</span> integral <span style="color:#75715e"># fused type for C short, int, long scalar types</span>
  
<span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">integral</span> <span style="color:#a6e22e">integral_max</span>(integral a, integral b):
    <span style="color:#66d9ef">return</span> a <span style="color:#66d9ef">if</span> a <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> b <span style="color:#66d9ef">else</span> b
  
<span style="color:#75715e"># Cython creates 3 integral_max: one for both as shorts, as ints, as longs</span>
<span style="color:#75715e"># using long if called from Python</span>
<span style="color:#75715e"># when called from other Cython ode, check arg type at compile time to set which to use</span>
  
<span style="color:#75715e"># allowed uses</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#a6e22e">allowed</span>():
    <span style="color:#66d9ef">print</span>(integral_max(&lt;<span style="color:#66d9ef">short</span>&gt;<span style="color:#ae81ff">1</span>, &lt;<span style="color:#66d9ef">short</span>&gt;<span style="color:#ae81ff">2</span>))
    <span style="color:#66d9ef">print</span>(integral_max(&lt;<span style="color:#66d9ef">int</span>&gt;<span style="color:#ae81ff">1</span>, &lt;<span style="color:#66d9ef">int</span>&gt;<span style="color:#ae81ff">2</span>))
    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
  
<span style="color:#75715e"># CANNOT mix for the same fused type from other Cython code</span>
  
<span style="color:#75715e"># to generalise support floats and doubles, cannot use cython.numeric fused type since complex are not comparable</span>
<span style="color:#75715e"># Can create own fused type to group integral and floating C types</span>
  
<span style="color:#66d9ef">cimport</span> cyhton
  
<span style="color:#66d9ef">ctypedef</span> <span style="color:#66d9ef">fused</span> integral_or_floating:
    cython<span style="color:#f92672">.</span>short
    cython<span style="color:#f92672">.</span>int
    cython<span style="color:#f92672">.</span>long
    cython<span style="color:#f92672">.</span>float
    cython<span style="color:#f92672">.</span>double
      
<span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">integral_or_floating</span> <span style="color:#a6e22e">generic_max</span>(integral_or_floating a,
                                      integral_or_floating b):
    <span style="color:#66d9ef">return</span> a <span style="color:#66d9ef">if</span> a <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> b <span style="color:#66d9ef">else</span> b
  
<span style="color:#75715e"># five spec, one each C type in ctypedef fused block</span>
</code></pre></div></li>
</ul>
</blockquote>
<h2 id="loop-and-while">Loop and While</h2>
<ul>
<li>
<p>if index <code>i</code> and <code>range</code> key <code>n</code> are DT, Cython may NOT be able to gen fast C loop; fixed by typing</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n):
    <span style="color:#75715e">#...</span>
</code></pre></div></li>
</ul>
<h3 id="guidelines-for-efficient-loops">Guidelines for Efficient Loops</h3>
<ul>
<li>
<p>TYPE <code>range</code> args as C int (Cython auto-gen <code>i</code> as int as well, <strong>provided not using index in body expression</strong>)</p>
</li>
<li>
<p>if certain index used in body will not cause overflow, ST <code>... a[i] = i + 1</code> for example</p>
</li>
<li>
<p><strong>when looping over container (<code>list, tuple, dict</code>, etc) ST index may introduce MORE overhead, depending on situation</strong> - <strong>CONVERT TO C++ EQUIVALENT or TYPED MEMORYVIEWS</strong> (more optimising loop bodies later in Cython NumPy support and typed memoryviews)</p>
</li>
<li>
<p><code>while</code> loops must make loop condition expression efficient - may use typed variables and <code>cdef</code> functions (<strong>simple <code>while True</code> loop with an internal <code>break</code> are efficiently translated to C automatically</strong>)</p>
</li>
<li>
<p>Examples</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># Python</span>
n <span style="color:#f92672">=</span> len(a) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
<span style="color:#75715e"># &#34;a&#34; list or array of floats</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, n):
    a[i] <span style="color:#f92672">=</span> (a[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> a[i] a[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]) <span style="color:#f92672">/</span> <span style="color:#ae81ff">3.0</span>
    
<span style="color:#75715e"># access `i` indices each iteration prevents direct iteration!</span>
<span style="color:#75715e"># almost Cython-friendly, only need to ad some typing for fast loop</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> len(a) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, n):
    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h2 id="cython-preprocessor-c-macro">Cython Preprocessor (C macro)</h2>
<ul>
<li><code>DEF</code> creates macro, a compile-time symbolic constant akin to <code>#define</code> in C</li>
<li><strong>useful for giving meaningful names to magic numbers, allowing them to be updated and changed in a single location</strong></li>
<li><strong>textually substituted with their value at compile time</strong></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e">DEF</span> E <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.718281828459045</span>
<span style="color:#75715e">DEF</span> PI <span style="color:#f92672">=</span> <span style="color:#ae81ff">3.14159263589</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">feymans_jewel</span>():
    <span style="color:#e6db74">&#34;&#34;&#34;Returns e**(i*pi) + 1. Should be ~0.0&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> E <span style="color:#f92672">*</span><span style="color:#f92672">*</span> (<span style="color:#ae81ff">1</span>j <span style="color:#f92672">*</span> PI) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.0</span>
</code></pre></div><ul>
<li>
<p>DEF constant must resolve at compile time and are restricted to simple types</p>
</li>
<li>
<p>can be <strong>literal integrals, floats, strings, predefined DEF variables calls to a set of predefined functions, or expressions involving these types</strong></p>
</li>
<li>
<p>set of predfined compile-time names from <code>os.uname</code></p>
<ul>
<li><code>UNAME_SYSNAME, UNAME_RELEASE, UNAME_VERSION, UNAME_MACHINE, UNAME_NODENAME</code></li>
</ul>
</li>
<li>
<p>types available for defining a DEF</p>
<ul>
<li>Constants - <code>None, True, False</code></li>
<li>Built-in functions - <code>abs, chr, cmp, divmod, enumerate, hash, hex, len, map, max, min, oct, ord, pow, rnage, reduce, repr, round, sum, xrange, zip</code></li>
<li>Built-in types - <code>bool, complex, dict, float, int, list, long, slice, str, tuple</code></li>
</ul>
</li>
<li>
<p><strong>RHS of DEF MUST ultimately eval to <code>int, float, string</code> object</strong></p>
</li>
<li>
<p>conditional preprocessors are not restricted like DEF constants</p>
<ul>
<li>
<p>e.g. branching on OS</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e">IF</span> UNAME_SYSNAME <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Windows</span><span style="color:#e6db74">&#34;</span>:
    <span style="color:#75715e"># ...Windows-specific code...</span>
<span style="color:#75715e">ELIF</span> UNAME_SYSNAME <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Darwin</span><span style="color:#e6db74">&#34;</span>:
    <span style="color:#75715e"># ...Mac-specific code...</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h1 id="chapter-4-practice-n-body-simulation">Chapter 4 Practice: N-Body Simulation</h1>
<ul>
<li>variables: initial positions, velocities in heliocentric coord-system using symplectic integrator (time-stepping scheme good for computing right trajectories)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Python</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(n, bodies<span style="color:#f92672">=</span>BODIES, ref<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">sun</span><span style="color:#e6db74">&#39;</span>):
    <span style="color:#75715e"># takes number of steps n to integrate initial conditions </span>
    <span style="color:#75715e"># of bodies with reference body i.e. the Sun</span>
    
    <span style="color:#75715e"># gets list of all bodies and makes pairs of all for ease of iteration</span>
    system <span style="color:#f92672">=</span> list(bodies<span style="color:#f92672">.</span>values()) 
    pairs <span style="color:#f92672">=</span> combinations(system)

    <span style="color:#75715e"># correct Sun&#39;s momentum to stay at the Cen of Mass</span>
    offset_momentum(bodies[ref], system)
    
    <span style="color:#75715e"># compute and print system&#39;s total energy</span>
    report_energy(system, pairs)
    
    <span style="color:#75715e"># Symplectic integrators good at conserving energy, used to test accuracy</span>
    <span style="color:#75715e"># after getting init energy, core compute in time step</span>
    <span style="color:#75715e"># unit of time is mean solar day, distance is one astro-unit, solar mass </span>
    advance(<span style="color:#ae81ff">0.01</span>, n, system, pairs)
    report_energy(system, pairs) <span style="color:#75715e"># should be close to pre-advance</span>
</code></pre></div><ul>
<li>
<p><code>time python nbody.py 500000</code> runs 13.21s user</p>
</li>
<li>
<p>first, profile <code>ipython --no-banner</code> and <code>%run -p nbody.py 500000</code></p>
<ul>
<li><code>advance()</code> consumes 99% of runtime, hence need ST and more efficient data structures</li>
</ul>
</li>
<li>
<p>then convert straight to <code>.pyx</code> and compile-run to check working</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># setup.py</span>
<span style="color:#f92672">from</span> distutils.core <span style="color:#f92672">import</span> setup
<span style="color:#f92672">from</span> Cython.Build <span style="color:#f92672">import</span> cythonize
    
setup(name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">nbody</span><span style="color:#e6db74">&#39;</span>,
     ext_modules<span style="color:#f92672">=</span>cythonize(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">nbody.pyx</span><span style="color:#e6db74">&#39;</span>))
</code></pre></div></li>
<li>
<p>need a driver script to run the main function inside the extension module</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># run_nbody.py</span>
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">from</span> nbody <span style="color:#f92672">import</span> main
    
main(int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]))
</code></pre></div></li>
<li>
<p>build <code>python setup.py build_ext -i</code></p>
</li>
<li>
<p>resulting runtime at 4.78s user, 2.8 times faster - <strong>WITHOUT ANY CHANGE, Cython provides this for free!</strong></p>
</li>
</ul>
</li>
</ul>
<h2 id="python-data-structure-and-organisation">Python Data Structure and Organisation</h2>
<ul>
<li>
<p>In Python, each body is a tuple of 3 elems, e.g. Sun's init condition</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">([<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>], <span style="color:#75715e"># pos</span>
 [<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>], <span style="color:#75715e"># velocity</span>
 SOLAR_MASS <span style="color:#75715e"># mass</span>
)
  
<span style="color:#75715e"># Jupiter&#39;s</span>
([ <span style="color:#ae81ff">4.84143144246472090e+00</span>,
<span style="color:#f92672">-</span><span style="color:#ae81ff">1.16032004402742839e+00</span>,
<span style="color:#f92672">-</span><span style="color:#ae81ff">1.03622044471123109e-01</span>],
[ <span style="color:#ae81ff">1.66007664274403694e-03</span> <span style="color:#f92672">*</span> DAYS_PER_YEAR,
<span style="color:#ae81ff">7.69901118419740425e-03</span> <span style="color:#f92672">*</span> DAYS_PER_YEAR,
<span style="color:#f92672">-</span><span style="color:#ae81ff">6.90460016972063023e-05</span> <span style="color:#f92672">*</span> DAYS_PER_YEAR],
<span style="color:#ae81ff">9.54791938424326609e-04</span> <span style="color:#f92672">*</span> SOLAR_MASS),
</code></pre></div></li>
<li>
<p><code>system</code> is a list of these tuples, <code>pairs</code> a list of all pairs of these tuples</p>
</li>
<li>
<p><strong>simulation accesses and updates the pos/velo of all planets often, so optimizing their representation is essential!</strong></p>
</li>
<li>
<p><code>advance</code> loop over all steps, each looping over all pairs of bodies</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">advance</span>(dt, n, bodies, pairs):
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n):
        <span style="color:#66d9ef">for</span> (([x1, y1, z1], v1, m1),
            ([x2, y2, z2], v2, m2)) <span style="color:#f92672">in</span> pairs:
                <span style="color:#75715e"># ...update velocities...</span>
        <span style="color:#66d9ef">for</span> (r, [vx, vy, vz], m) <span style="color:#f92672">in</span> bodies: <span style="color:#75715e"># update velocities</span>
            r[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span><span style="color:#f92672">=</span> dt <span style="color:#f92672">*</span> vx
            r[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span><span style="color:#f92672">=</span> dt <span style="color:#f92672">*</span> vy
            r[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span><span style="color:#f92672">=</span> dt <span style="color:#f92672">*</span> vz
                
</code></pre></div></li>
<li>
<p><strong><code>bodies</code> and <code>paris</code> seq are set up to refer to the same objects, so updating both is possible in sequence, even though looping over difference seq</strong></p>
</li>
</ul>
<h2 id="converting-python-data-to-structs">Converting Python Data to structs</h2>
<ul>
<li>
<p>Strategy for speed: convert <strong>list-of-tuples-of-lists-of-floats</strong> into <strong>C array of C structs</strong></p>
</li>
<li>
<p><strong>C struct will have much better R/W performance, as using fast C iteration and lookups, rather than the general sloow Python interpreter</strong></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># body_t, two double arrays for pos and velo, and a single double for mass</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">body_t</span>:
    double x[<span style="color:#ae81ff">3</span>]
    double v[<span style="color:#ae81ff">3</span>]
    double m
</code></pre></div></li>
<li>
<p><strong>leave most of Python code intact and ONLY use struct where performance matters !!</strong></p>
</li>
<li>
<p><code>advance</code> needs to convert Python list-tuples of bodies into C struct using <code>cdef</code> function pair for conversion!</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># first, list to struct</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">make_cbodies</span>(list bodies, body_t <span style="color:#f92672">*</span>cbodies)
<span style="color:#75715e"># loops over the bodies list and init prealloc cbodies array with Python&#39;s list data</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">make_cbodies</span>(list bodies, body_t <span style="color:#f92672">*</span>cbodies, int num_cbodies):
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">body_t</span> *<span style="color:#a6e22e">cbody</span>
    <span style="color:#66d9ef">for</span> i, body <span style="color:#f92672">in</span> enumerate(bodies):
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> num_cbodies:
            <span style="color:#66d9ef">break</span>
        (x, v, m) <span style="color:#f92672">=</span> body
        cbody <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>cbodies[i]
        cbody<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>], cbody<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>], cbody<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> x
        cbody<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">0</span>], cbody<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">1</span>], cbody<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> v
        cbodies[i]<span style="color:#f92672">.</span>m <span style="color:#f92672">=</span> m
    
<span style="color:#75715e"># its complement, converting body_t array into Python list of tuples</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">list</span> <span style="color:#a6e22e">make_pybodies</span>(body_t <span style="color:#f92672">*</span>cbodies, int num_cbodies):
    pybodies <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_cbodies):
        x <span style="color:#f92672">=</span> [cbodies[i]<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>], cbodies[i]<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>], cbodies[i]<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">2</span>]]
        v <span style="color:#f92672">=</span> [cbodies[i]<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">0</span>], cbodies[i]<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">1</span>], cbodies[i]<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">2</span>]]
        pybodies<span style="color:#f92672">.</span>append((x, v, cbodies[i]<span style="color:#f92672">.</span>m))
    <span style="color:#66d9ef">return</span> pybodies
    
<span style="color:#75715e"># ready to convert for loops in advance to use ST</span>
    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">advance</span>(double dt, int n, bodies):
    <span style="color:#75715e"># Note this does NOT take a `pairs` arg, and returns a new `bodies` list.</span>
    <span style="color:#75715e"># This is slightly diff from original </span>
    <span style="color:#66d9ef">cdef</span>:
        int i, ii, jj
        double dx, dy, dz, mag, b1m, b2m,
        body_t <span style="color:#f92672">*</span>body1
        body_t <span style="color:#f92672">*</span>body2
        body_t cbodies[NBODIES]
    
    make_cbodies(bodies, cbodies, NBODIES)
    
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n):
        <span style="color:#66d9ef">for</span> ii <span style="color:#f92672">in</span> range(NBODIES<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>):
            body1 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>cbodies[ii]
            <span style="color:#66d9ef">for</span> jj <span style="color:#f92672">in</span> range(ii<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, NBODIES):
                body2 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>cbodies[jj]
                dx <span style="color:#f92672">=</span> body1<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> body2<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>]
                dy <span style="color:#f92672">=</span> body1<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> body2<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>]
                dz <span style="color:#f92672">=</span> body1<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">-</span> body2<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">2</span>]
                mag <span style="color:#f92672">=</span> dt <span style="color:#f92672">*</span> ((dx <span style="color:#f92672">*</span> dx <span style="color:#f92672">+</span> dy <span style="color:#f92672">*</span> dy <span style="color:#f92672">+</span> dz <span style="color:#f92672">*</span> dz) <span style="color:#f92672">*</span><span style="color:#f92672">*</span> (<span style="color:#f92672">-</span><span style="color:#ae81ff">1.5</span>))
                b1m <span style="color:#f92672">=</span> body1<span style="color:#f92672">.</span>m <span style="color:#f92672">*</span> mag
                b2m <span style="color:#f92672">=</span> body2<span style="color:#f92672">.</span>m <span style="color:#f92672">*</span> mag
                body1<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span><span style="color:#f92672">=</span> dx <span style="color:#f92672">*</span> b2m
                body1<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span><span style="color:#f92672">=</span> dy <span style="color:#f92672">*</span> b2m
                body1<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">-</span><span style="color:#f92672">=</span> dz <span style="color:#f92672">*</span> b2m
                body2<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span><span style="color:#f92672">=</span> dx <span style="color:#f92672">*</span> b1m
                body2<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span><span style="color:#f92672">=</span> dy <span style="color:#f92672">*</span> b1m
                body2<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span><span style="color:#f92672">=</span> dz <span style="color:#f92672">*</span> b1m
        <span style="color:#66d9ef">for</span> ii <span style="color:#f92672">in</span> range(NBODIES):
            body2 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>cbodies[ii]
            body2<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span><span style="color:#f92672">=</span> dt <span style="color:#f92672">*</span> body2<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">0</span>]
            body2<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span><span style="color:#f92672">=</span> dt <span style="color:#f92672">*</span> body2<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">1</span>]
            body2<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span><span style="color:#f92672">=</span> dt <span style="color:#f92672">*</span> body2<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">2</span>]
    
<span style="color:#66d9ef">return</span> make_pybodies(cbodies, NBODIES)	
</code></pre></div></li>
<li>
<p><strong>for loop converted to nested for loops over indices into C array of body_t structs</strong>, <strong>using two body_t pointers to refer to the current bodies in the pair</strong></p>
</li>
<li>
<p>removed pairs arg to advance, so need to update main</p>
</li>
</ul>
</li>
</ul>
<h3 id="running-cythonized-version">Running Cythonized version</h3>
<ul>
<li>0.54s user - 25 times faster</li>
<li>serial hand-written C runs 0.14s user, 4 times faster</li>
<li>C code <code>advance</code> uses <code>sqrt</code> to compute distance! the above uses <code>**</code> operator and <code>pow</code> =&gt; straightforwad to use sqrt <code>ds = dx * dx + dy * dy + dz * dz; mag = dt / (ds * sqrt(ds))</code></li>
<li>this requires type <code>ds</code> as a double and add a cimport <code>from libc.math cimport sqrt</code> for C speed</li>
<li>with this change, the final speed is 0.15s user, 90 x faster than pure Python</li>
</ul>
<h2 id="conversion-summary">Conversion Summary</h2>
<ol>
<li>Profile using <code>cProfile</code> or <code>%run</code> to see most runtime</li>
<li>Inspect hotspots for <strong>nested loops, numeric-heavy ops, nested Python containers</strong>, all can be easily converted with Cython to use more efficient C constructs (above case have all)</li>
<li>Use Cython to declare C data structures equivalent to Python's. Create converters if needed to transform Python data to C data. In the N-body simu, <code>body_t</code> struct to represent nested that-long-name, getting better data locality and fast access! Two converters, <code>make_cbodies, make_pybodies</code> to convert to and fro both</li>
<li>Convert hotspots to use C data, removing Python data from nested loops to the extent possible - ensuring all variables used in nested loop (including loop variables) are ST!</li>
<li>Test to check semantics intact</li>
</ol>
<h2 id="detail-code-study">Detail Code Study</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># cython setup.py</span>
<span style="color:#66d9ef">from</span> distutils.core <span style="color:#66d9ef">import</span> setup
<span style="color:#66d9ef">from</span> Cython.Build <span style="color:#66d9ef">import</span> cythonize

setup(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">nbody</span><span style="color:#e6db74">&#34;</span>,
      ext_modules<span style="color:#f92672">=</span>cythonize(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">nbody.pyx</span><span style="color:#e6db74">&#34;</span>))

<span style="color:#75715e"># global definition the same; maybe Cython could do typed</span>

<span style="color:#75715e"># Python def BODIES</span>
BODIES <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">sun</span><span style="color:#e6db74">&#39;</span>: ([<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>]),
    <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">jupiter</span><span style="color:#e6db74">&#39;</span>: <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
}
<span style="color:#75715e"># Cython need struct</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">body_t</span>:
    double x[<span style="color:#ae81ff">3</span>]
    double v[<span style="color:#ae81ff">3</span>]
    double m

<span style="color:#75715e">DEF</span> NBODIES <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>

BODIES <span style="color:#f92672">=</span> {
    <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span> <span style="color:#75715e"># same as python</span>
}

<span style="color:#75715e"># Python</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">advance</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span> <span style="color:#75715e"># see above</span>

<span style="color:#75715e"># Python</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">report_energy</span>(bodies, pairs):

    e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>

    <span style="color:#66d9ef">for</span> (((x1, y1, z1), v1, m1),
            ((x2, y2, z2), v2, m2)) <span style="color:#f92672">in</span> pairs:
        dx <span style="color:#f92672">=</span> x1 <span style="color:#f92672">-</span> x2
        dy <span style="color:#f92672">=</span> y1 <span style="color:#f92672">-</span> y2
        dz <span style="color:#f92672">=</span> z1 <span style="color:#f92672">-</span> z2
        e <span style="color:#f92672">-</span><span style="color:#f92672">=</span> (m1 <span style="color:#f92672">*</span> m2) <span style="color:#f92672">/</span> ((dx <span style="color:#f92672">*</span> dx <span style="color:#f92672">+</span> dy <span style="color:#f92672">*</span> dy <span style="color:#f92672">+</span> dz <span style="color:#f92672">*</span> dz) <span style="color:#f92672">*</span><span style="color:#f92672">*</span> <span style="color:#ae81ff">0.5</span>)
    <span style="color:#66d9ef">for</span> (r, [vx, vy, vz], m) <span style="color:#f92672">in</span> bodies:
        e <span style="color:#f92672">+</span><span style="color:#f92672">=</span> m <span style="color:#f92672">*</span> (vx <span style="color:#f92672">*</span> vx <span style="color:#f92672">+</span> vy <span style="color:#f92672">*</span> vy <span style="color:#f92672">+</span> vz <span style="color:#f92672">*</span> vz) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2.</span>
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%.9f</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> e)
    
<span style="color:#75715e"># Cython</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">report_energy</span>(bodies):
    <span style="color:#75715e"># no `pairs` arg but compute internally</span>
    e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>
    paris <span style="color:#f92672">=</span> combinations(bodies)
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
    <span style="color:#75715e"># the same</span>
    
<span style="color:#75715e"># Cython auxiliaries</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">make_cbodies</span>(list bodies, body_t <span style="color:#f92672">*</span>cbodies, int num_cbodies):
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">body_t</span> *<span style="color:#a6e22e">cbody</span>
    <span style="color:#66d9ef">for</span> i, body <span style="color:#f92672">in</span> enumerate(bodies):
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> num_cbodies:
            <span style="color:#66d9ef">break</span>
        (x, v, m) <span style="color:#f92672">=</span> body
        cbody <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>codies[i]
        cbody<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>], cbody<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>], cbody<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> x
        cbody<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">0</span>], cbody<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">1</span>], cbody<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> v
        cbodies[i]<span style="color:#f92672">.</span>m <span style="color:#f92672">=</span> m
        
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">list</span> <span style="color:#a6e22e">make_pybodies</span>(body_t <span style="color:#f92672">*</span>cbodies, int num_cbodies):
    pybodies <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_cbodies):
        x <span style="color:#f92672">=</span> [cbodies[i]<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>], cbodies[i]<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>], cbodies[i]<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">2</span>]]
        v <span style="color:#f92672">=</span> [cbodies[i]<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">0</span>], cbodies[i]<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">1</span>], cbodies[i]<span style="color:#f92672">.</span>v[<span style="color:#ae81ff">2</span>]]
        pybodies<span style="color:#f92672">.</span>append((x, v, cbodies[i]<span style="color:#f92672">.</span>m))
    <span style="color:#66d9ef">return</span> pybodies

<span style="color:#75715e"># the same </span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">offset_momentum</span>(ref, bodies):

    px <span style="color:#f92672">=</span> py <span style="color:#f92672">=</span> pz <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>

    <span style="color:#66d9ef">for</span> (r, [vx, vy, vz], m) <span style="color:#f92672">in</span> bodies:
        px <span style="color:#f92672">-</span><span style="color:#f92672">=</span> vx <span style="color:#f92672">*</span> m
        py <span style="color:#f92672">-</span><span style="color:#f92672">=</span> vy <span style="color:#f92672">*</span> m
        pz <span style="color:#f92672">-</span><span style="color:#f92672">=</span> vz <span style="color:#f92672">*</span> m
    (r, v, m) <span style="color:#f92672">=</span> ref
    v[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> px <span style="color:#f92672">/</span> m
    v[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> py <span style="color:#f92672">/</span> m
    v[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> pz <span style="color:#f92672">/</span> m

    
<span style="color:#75715e"># python</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(n, bodies<span style="color:#f92672">=</span>BODIES, ref<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">sun</span><span style="color:#e6db74">&#39;</span>):
    system <span style="color:#f92672">=</span> list(bodies<span style="color:#f92672">.</span>values())
    pairs <span style="color:#f92672">=</span> combinations(system)
    offset_momentum(bodies[ref], system)
    report_energy(system, pairs)
    advance(<span style="color:#ae81ff">0.01</span>, n, system, pairs)
    report_energy(system, pairs)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
    main(int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]), bodies<span style="color:#f92672">=</span>BODIES, ref<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">sun</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#75715e"># cyhton</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(n, bodies<span style="color:#f92672">=</span>BODIES, ref<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">sun</span><span style="color:#e6db74">&#39;</span>):
    system <span style="color:#f92672">=</span> list(bodies<span style="color:#f92672">.</span>values())
    offset_momentum(bodies[ref], system)
    report_energy(system)
    system <span style="color:#f92672">=</span> advance(<span style="color:#ae81ff">0.01</span>, n, system)
    report_energy(system)

<span style="color:#75715e"># DIFF: separete run_nbody.py using pyx (after build)</span>
<span style="color:#66d9ef">import</span> sys
<span style="color:#66d9ef">from</span> nbody <span style="color:#66d9ef">import</span> main
main(int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]))
<span style="color:#75715e"># Makefile</span>
all: nbody<span style="color:#f92672">.</span>so
nbody<span style="color:#f92672">.</span>so: nbody<span style="color:#f92672">.</span>pyx
    cython <span style="color:#f92672">-</span>a nbody<span style="color:#f92672">.</span>pyx
    python setup<span style="color:#f92672">.</span>py build_ext <span style="color:#f92672">-</span>fi
clean:
    <span style="color:#f92672">-</span>rm <span style="color:#f92672">-</span>r build nbody<span style="color:#f92672">.</span>so nbody<span style="color:#f92672">.</span>c nbody<span style="color:#f92672">.</span>html
</code></pre></div><h1 id="chapter-5-extension-type">Chapter 5 Extension Type</h1>
<h2 id="comparing-py-class-and-ext-type">Comparing Py-Class and Ext Type</h2>
<ul>
<li>Python all is object - WHAT?
<ul>
<li>object has <strong>identity, value, type</strong>  - typically value or data is under <code>__dict__</code> ;</li>
<li>a type is responsible for creating and destroying its objects ! with <code>class</code></li>
<li>how Cython allows low-C access to an object's data and methods, benefit?</li>
<li>built-in types in Python all implemented at C level via Python/C API, incorporated into the Python runtime.</li>
<li>they behaves just like regular Python classes</li>
</ul>
</li>
<li><strong>Extension types</strong> - self-made C-level types via API
<ul>
<li>when using them, running compiled and ST code ! - having fast C-level access to types&rsquo; methods and instances&rsquo; data!</li>
<li>direct Python/C API creation is not for the uninitiated, hence Cython <code>cdef class</code></li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># Example</span>
<span style="color:#75715e"># when compiled to C, resulting cls just regular Python, NOT ext_type!</span>
<span style="color:#75715e"># small boost due to pre-compilation skipping interpreter overhead</span>
<span style="color:#75715e"># real boost comes with ST</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Particle</span>:
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">mass</span>, <span style="color:#a6e22e">position</span>, <span style="color:#a6e22e">velocity</span>
	<span style="color:#75715e"># the rest of __init__ and get_momentum(self) INTACT</span>
</code></pre></div><ul>
<li><strong>the <code>cdef</code> type declarations in class body are NOT class-level attributes!! They are C instance attributes!! similar to C++ declaration.</strong></li>
<li><strong>ALL INSTANCE ATTRIBUTES MUST BE DECLARED WITH <code>CDEF</code> AT THE CLASS LEVEL IN THIS WAY FOR EXTENSION TYPES</strong></li>
<li><strong>CANNOT ACCESS EXT_TYPE CLASS ATTRIBUTES NOR ASSIGN NEW OR MOD!!</strong>
<ul>
<li>when ext_type init, a C <code>struct</code> is <strong>allocated and init</strong> requiring the <strong>size and fields</strong> be known at COMPILE TIME, hence need to declare ALL attributes with cdef</li>
<li>In contrast, Py-object init creating at interpret time <code>__dict__</code> attribute</li>
<li>C structs are fixed and not open to new members! <strong>private by default</strong>  - python class is wide open</li>
</ul>
</li>
</ul>
<h2 id="type-attributes-and-access-control">Type Attributes and Access Control</h2>
<ul>
<li>
<p>py-class attribute goes through a general lookup process that works for any attribute, instance attribute or method or data attribute inside base cls etc. - several level of indirection to search for target = overhead</p>
</li>
<li>
<p><strong>Methods defined in <code>cdef class</code> extension types have FULL ACCESS to ALL instance attributes - cython will translate any accesses like <code>self.mass</code> into low-level accesses to C-struct fileds!</strong> bypassing lookup</p>
</li>
<li>
<p>WHAT IF wanting access? Make <strong>read-only or readable and writable</strong></p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># read-only attributes</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Particle</span>:
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">mass</span>
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">position</span>, <span style="color:#a6e22e">velocity</span>
<span style="color:#75715e"># need recompile </span>
    
<span style="color:#75715e"># R/W attributes</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Particle</span>:
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">mass</span>
    <span style="color:#75715e"># ...</span>
    <span style="color:#75715e"># cy_particle.mass = 12-6</span>
</code></pre></div><ul>
<li>when calling method Cython still uses fast C-level direct access and essentially ignoring readonly and pubic declarations - exist only to allow and control access from Python runtime!</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="c-level-init-and-final">C-Level INIT and FINAL</h2>
<ul>
<li>
<p>C-struct in ext_type has implications:</p>
<ul>
<li>
<p>when Python calls <code>__init__</code>, the <code>self</code> arg is required to be a valid instance of that ext_type; <code>__init__</code> call typically init attributes on <code>self</code> arg</p>
</li>
<li>
<p>at C, before <code>__init__</code> called, the instance's struct must be ALLOC, all struct fields must be in a valid state, ready to accept initial values</p>
</li>
<li>
<p>Cython adds a special <code>__cinit__</code> performing C ALLOC and INIT</p>
</li>
<li>
<p><strong>the above <code>Particle.__init__</code> can take on this role because the fields are all <code>double</code> scalars and require no C ALLOC</strong> , BUT possible, depending on how ext_type is <strong>subclassed or alternative constructors</strong>, for <code>__init__</code> to be called multiple times during object creation, and other cases where `__init__`` is bypassed entirely</p>
</li>
<li>
<p>Cython guarantees that <code>__cinit__</code> called exactly once and called before <code>__init__</code>, <code>__new__</code> or alternative Python-level constructors (e.g. <code>classmethod</code> constructors); Cython passes any INIT args into <code>__cinit__</code></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># instances with internal C array, dynamically allocated</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Matrix</span>:
    <span style="color:#66d9ef">cdef</span>:
        unsigned int nrows, ncols
        double <span style="color:#f92672">*</span>_matrix
    <span style="color:#75715e"># the CORRECT place to put `self._matrix` dynamically allocation is `__cinit__`</span>
    <span style="color:#66d9ef">cdef</span> <span style="color:#a6e22e">__cinit__</span>(self, nr, nc):
        self<span style="color:#f92672">.</span>nrows <span style="color:#f92672">=</span> nr
        self<span style="color:#f92672">.</span>ncols <span style="color:#f92672">=</span> nc
        self<span style="color:#f92672">.</span>_matrix <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>double<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>malloc(nr <span style="color:#f92672">*</span> nc <span style="color:#f92672">*</span> sizeof(double))
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_matrix <span style="color:#f92672">==</span> NULL:
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">MemoryError</span>()
    <span style="color:#75715e"># deconstrutor</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__dealloc__</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_matrix <span style="color:#f92672">!=</span> NULL:
            free(self<span style="color:#f92672">.</span>_matrix)
</code></pre></div><ul>
<li>if <code>self._matrix</code> allocated inside <code>__init__</code> instead, it would never be called - which can occur with an alternate <code>classmethod</code> constructor - then any method using <code>self._matrix</code> would lead to ugly segmentation faults</li>
<li>conversely, if <code>__init__</code> called twice - perhaps due to inconsistent use of <code>super</code> in a class hierarchy - then a MEM_LEAK would result (particularly hard to track down)</li>
<li>CLEANUP: Cython uses C FIN <code>__dealloc__</code> taking care of undoing <code>__cinit__</code> (see above)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="cdef-and-cpdef-methods">cdef and cpdef Methods</h2>
<ul>
<li>
<p>concepts in CH3 about <code>def, cdef, cpdef</code> <strong>functions</strong> also apply to <strong>extension type methods</strong>; NOTE cannot use <code>cdef, cpdef</code> to define methods on non-cdef classes</p>
</li>
<li>
<p><strong>cdef methods has C calling semantics, just as cdef functions do: all args are passed in as is, no type mapping from Python to C!</strong></p>
</li>
<li>
<p>hence cdef methods cannot be accessed from Python</p>
</li>
<li>
<p><code>cpdef</code> method is particularly useful - callable from external Python code and other Cython code!</p>
</li>
<li>
<p><strong>HOWEVER, the input/output types have to be automatically convertible to and fro Python objects (no pointer types for example)</strong></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># cpdef method in Particle</span>
<span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">get_momentum</span>(self):
    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>mass <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>velocity
  
<span style="color:#75715e"># a function</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_momentums</span>(particles):
    total_mom <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>
    <span style="color:#66d9ef">for</span> particle <span style="color:#f92672">in</span> particles:
        total_mom <span style="color:#f92672">+</span><span style="color:#f92672">=</span> particle<span style="color:#f92672">.</span>get_momentum()
  <span style="color:#66d9ef">return</span> total_mom
  
<span style="color:#75715e"># faster with typing</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_momentums_typed</span>(list particles):
    <span style="color:#66d9ef">cdef</span>:
        double total_mom <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>
        Particle particle
  <span style="color:#66d9ef">for</span> particle <span style="color:#f92672">in</span> particles:
        total_mom <span style="color:#f92672">+</span><span style="color:#f92672">=</span> particle<span style="color:#f92672">.</span>get_momentum()
  <span style="color:#66d9ef">return</span> total_mom
  
<span style="color:#75715e"># NOTE: arg type is list, double and CRUCIALLY, the loop indexing variable particle as a Particle !!</span>
<span style="color:#75715e"># hence when get `get_momentum` called in this typed func (def)!! no Python objects are invovled !!</span>
<span style="color:#75715e"># Even the in-place sum is C-only operation !! since total_mom is ST C double</span>
  
</code></pre></div><ul>
<li>this could be defined in interpreted Python, or it could be compiled and run by Cython - either case, the call to <code>get_momentum</code> is a fully general Python attribute lookup and call, since Cython does not know that <code>particles</code> is list of <code>Particle</code> objects</li>
<li><strong>when Python calls get_momentum on a Particle object, the get_momentum Python wrapper is used, and the correct packing and unpacking from Python object to underlying Particle struct occurs auto</strong></li>
</ul>
</li>
<li>
<p>to see the effect of <code>cpdef</code> over <code>def</code> method, remove the <code>Particle particle</code> declaration, forcing Cython to use Python calling semantics on <code>particle.get_momentum()</code> - slower than ALL-PYTHON version! <code>particle</code> as loop variable here yields the most speed, typing <code>particles</code> and <code>total_mom</code> has less of an effect</p>
</li>
<li>
<p>WHAT IF <code>get_momentum</code> is <code>cdef</code> method?</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># another method</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Particle</span>:
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">mass</span>, <span style="color:#a6e22e">position</span>, <span style="color:#a6e22e">velocity</span>
    <span style="color:#75715e"># ...</span>
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">get_momentum_c</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>mass <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>velocity
    
<span style="color:#75715e"># will have to modify add_momentums_typed </span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_momentums_typed_c</span>(list particles):
    <span style="color:#66d9ef">cdef</span>:
        double total_mom <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>
        Particle particle
    <span style="color:#66d9ef">for</span> particle <span style="color:#f92672">in</span> particles:
        total_mom <span style="color:#f92672">+</span><span style="color:#f92672">=</span> particle<span style="color:#f92672">.</span>get_momentum_c()
    <span style="color:#66d9ef">return</span> total_mom
</code></pre></div><ul>
<li><strong>fastest! (40%) BUT DOWNSIDE is that <code>get_momentum_c</code> is NOT callable from Python, only Cython - since these are trivial, the speedups are skewed heavily toward function call overhead. For more heavy calculations, the speed difference between <code>cdef</code> and <code>cpdef</code> will be INSIGNIFICANT, while the FLEXIBILITY <code>cpdef</code> becomes more relevant</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="inheritance-and-subclassing">Inheritance and Subclassing</h2>
<ul>
<li>
<p><strong>CAN SUBCLASS a SINGLE BASE TYPE</strong>, which must itself be a type implemented in C - either built-in or another ext_type !</p>
</li>
<li>
<p>For example, subclass of <code>Particle, CParticle</code>, storing particle's momentum rather than computing it on the fly - do not want duplicate work done in Particle, so subclass it</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CParticle</span>(Particle):
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">momentum</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, m, p, v):
        super(CParticle, self)<span style="color:#f92672">.</span>__init__(m, p, v)
        self<span style="color:#f92672">.</span>momentum <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>mass <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>velocity
  <span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">get_momentum</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>momentum
</code></pre></div><ul>
<li>
<p>Because <code>CParticle</code> is a more specific <code>Particle</code>, everywhere using a <code>Particle</code>, should be able to sub in <code>CParticle</code> without code change - all while we revel in Platonic beauty of polymorphism.</p>
</li>
<li>
<p><strong>In all above methods/functions can pass in a list of <code>CParticle</code> - the <code>add_momentums</code> function does everything with dynamic Python variables, so all follows Python semantics there - BUT <code>add_momentums_typed</code> expects the elements of the list to be <code>Particle</code> instances, when <code>CParticles</code> passed in, the RIGHT version of <code>get_momentum</code> is RESOLVED, bypassing the Python/C API</strong></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># subclass Particle in pure Python</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PyParticle</span>(Particle):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, m, p, v):
        super(PyParticle, self)<span style="color:#f92672">.</span>__init__(m, p, v)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_momentum</span>(self):
        <span style="color:#66d9ef">return</span> super(PyParticle, self)<span style="color:#f92672">.</span>get_momentume()
</code></pre></div><ul>
<li>cannot access any private C attributes or <code>cdef</code> methods</li>
<li>CAN override <code>def</code> and <code>cpdef</code> methods</li>
<li>CAN pass <code>PyParicles</code> to list as well</li>
</ul>
</li>
<li>
<p><strong>Crossing Cython/Python boundary polymorphically is nice, but it does have overhead</strong></p>
<ul>
<li>becaues <code>cdef</code> method is inaccessible or not overrideable from Python, it does not have to cross the language boundary, so it has less call overhead than <code>cpdef</code> equivalent. Relevant concern only for small functions where call overhead is non-negligible</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="casting-and-subclass">Casting and Subclass</h2>
<ul>
<li>
<p>when working with a DT object, Cython cannot access any C data or methods on it! All attribute lookup must be done via API slow! If knew dynamic variable is or may possibly be an instance of a built-in type or an extension type, THEN it is worth <strong>casting to the ST</strong> - allowing Cython to access C attributes and methods - further Cython can also access Python attributes and <code>cpdef</code> methods directly without going through API</p>
</li>
<li>
<p>casting: either by creating a ST variable of desired type and assigning the dynamic variable to it, OR using Cython's casting operator</p>
</li>
<li>
<p>Example: an object <code>p</code> might be instance of <code>Particle</code> or one of its subclasses, ALL cython knows about <code>p</code> is that it is a Python object, can call <code>get_momentum</code> which works if <code>p</code> has such a method and fail otherwise; because <code>p</code> is a <strong>dynamic variable</strong>, Cython will access <code>get_momentum</code> looking up in a Python dictionary, if OK, <code>PyObject_Call</code> will exec the method - BUT if casting it to a <code>Particle</code> <strong>explicitly</strong>, the call is faster:</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">Particle</span> <span style="color:#a6e22e">static_p</span> <span style="color:#f92672">=</span> p
<span style="color:#66d9ef">print</span> static_p<span style="color:#f92672">.</span>get_momentum()
<span style="color:#66d9ef">print</span> static_p<span style="color:#f92672">.</span>velocity
  
<span style="color:#75715e"># assignment raise TypeError if p is not an instance of Particle or its subcls</span>
<span style="color:#75715e"># call to method uses direct access to cpdef method</span>
<span style="color:#75715e"># allowed access to private velocity attribute, which is not available to p !!</span>
  
<span style="color:#75715e"># NOTE Cython uses general Python method lookups on DT objects, failling with an</span>
<span style="color:#75715e"># AttributeError if method is declared cdef; to ensure fast access to cpdef methods, or to </span>
<span style="color:#75715e"># allow any access to cdef methods, must provide ST info for th object</span>
  
<span style="color:#75715e"># casting way</span>
<span style="color:#66d9ef">print</span> (&lt;<span style="color:#66d9ef">Particle</span>&gt;p)<span style="color:#f92672">.</span>get_momentum()
  
<span style="color:#75715e"># this removes need to create a temp_var </span>
<span style="color:#75715e"># () due to precedence rules</span>
<span style="color:#75715e"># as using a raw cast to Particle, no type checking is performed for speed</span>
<span style="color:#75715e"># unsafe if p not an instance of Particle, leading to segmentation fault</span>
<span style="color:#75715e"># if such possible:</span>
<span style="color:#66d9ef">print</span> (&lt;<span style="color:#66d9ef">Particle?</span>&gt;p)<span style="color:#f92672">.</span>get_momentum() <span style="color:#75715e"># TypeError, tradeoff is checked cast calls into API and incurs runtime overhead</span>
</code></pre></div></li>
</ul>
<h2 id="extension-type-objects-and-none">Extension Type Objects and None</h2>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dispatch</span>(Particle p):
    <span style="color:#66d9ef">print</span> p<span style="color:#f92672">.</span>get_momentum()
    <span style="color:#66d9ef">print</span> p<span style="color:#f92672">.</span>velocity
      
<span style="color:#75715e"># if calling dispath and pass NON-Particle object, then TypeError</span>
dispatch(Particle(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>)) <span style="color:#75715e"># OK</span>
dispatch(CParticle(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>)) <span style="color:#75715e"># OK</span>
dispatch(PyParticle(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>)) <span style="color:#75715e"># OK</span>
dispatch(object()) <span style="color:#75715e"># TypeError</span>
  
<span style="color:#75715e"># calling dispatch with None does not result in TypeError</span>
dispatch(None) <span style="color:#75715e"># Segmentation fault!</span>
</code></pre></div><ul>
<li>
<p>However, Cython treats <code>None</code> specially - though not an instance of Particle, allows it to be passed in as if it were - analogous to NULL pointer in C:</p>
<ul>
<li>allowed wherever a C pointer is expected, but doing anything other than checking whether it is NULL will result in segmentation fault or worse!</li>
</ul>
</li>
<li>
<p>Why? because dispatch(unsafely) accesses the cpdef function get_momentum and the private attribute both are C interface; Python's none object essentially has NO C interface, so trying to call a method on it or access an <strong>attribute is not valid - to be safe, check if p is None first:</strong></p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dispatch</span>(Particle p):
    <span style="color:#66d9ef">if</span> p <span style="color:#f92672">is</span> None:
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">...</span><span style="color:#e6db74">&#34;</span>)
      
<span style="color:#75715e"># so common for special syntax</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dispatch</span>(Particle p <span style="color:#f92672">not</span> None):
    <span style="color:#75715e"># ...</span>
</code></pre></div><ul>
<li>safety at up-front type checking</li>
<li><strong>IF ANY POSSIBILITY THAT A FUNC OR METHOD ARG MIGHT BE NONE, need this cost to guard agasint it if accessing any C attributes or methods on the object</strong></li>
<li>SEGMENTATION FAULT AND DATA CORRUPTION</li>
<li>If access only Python methods (def methods) and Python attributes (<code>public, readonly</code>) on the object, then exception will be raised, API handles for us</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Cython also provides <code>nonecheck</code> compiler directive - off by default for speed <code># cython: nonecheck=True</code></p>
</li>
<li>
<p>or <code>cython --directive nonecheck=True source.pyx</code></p>
</li>
</ul>
</li>
</ul>
<h2 id="extension-type-properties">Extension Type Properties</h2>
<ul>
<li>
<p><strong>Python properties handy and powerful, allowing precise control over attribute access and on-the-fly computation!</strong></p>
</li>
<li>
<p>E.g. Particle ext_type has <code>get_momentum</code> method, but Pythonically horrendous a getter method like that; should be either exposing <code>momentum</code> directly or make a property instead</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># pure python</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Particle</span>(object):
    <span style="color:#75715e">#...</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_momentum</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>mass <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>velocity
    momentum <span style="color:#f92672">=</span> property(_get_momentum)
  
<span style="color:#75715e"># CANNOT set or delete p.momentum because no setter or deleter in property definition</span>
  
<span style="color:#75715e"># Cython diff syntax but same end</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Particle</span>:
    <span style="color:#75715e"># ....</span>
    <span style="color:#66d9ef">property</span> <span style="color:#a6e22e">momentum</span>:
        __get__(self):
            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>mass <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>velocity
</code></pre></div><ul>
<li><strong>knowing ST gives faster access, this is a read-only property</strong></li>
</ul>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># setter</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__set__</span>(self, m):
    self<span style="color:#f92672">.</span>velocity <span style="color:#f92672">=</span> m <span style="color:#f92672">/</span> self<span style="color:#f92672">.</span>mass
</code></pre></div><ul>
<li>arbitrarily decide that setting momentum will modify velocity and leave mass intact, allowing assignment</li>
<li><code>p = cython_particle.Particle(1, 2, 3); p.momentum = 4.0; p.velocity == </code></li>
<li><strong><code>__del__</code> property controls deletion - decoupled the three !!</strong></li>
</ul>
</li>
</ul>
<h2 id="special-methods-are-even-more-special">Special Methods Are Even More SPECIAL</h2>
<ul>
<li>when providing support for operator overloading with ext_type, need to define a special method - specifc name with leading and trailling double underscores</li>
<li>Extension types do not support <code>__del__</code>, that's the role of <code>__dealloc__</code></li>
</ul>
<h3 id="arithmetic">Arithmetic</h3>
<ul>
<li>
<p><code>__add__(self, other)</code> enables <code> c + d</code> to call <code>C.__add__(c, d)</code> ; if not implemented, Python interpreter calls <code>type(d).__radd__(d, c)</code> to give d's class a chance to add itself to a C instance</p>
</li>
<li>
<p>Applied to ALL extension type (beyond Cython): DO NOT support <code>__radd__</code>, instead effectively overload <code>__add__</code> to do BOTH regular and class-type - meaning for a Cython-defined extension type E, <code>__add__</code> will be called when expression <code>f + e</code>  is eval and ALSO call when <code>f + e</code> eval.</p>
<ul>
<li>
<p><code>E.__add__</code> called with f and e as args, IN THAT ORDER!</p>
</li>
<li>
<p>so <code>__add__</code> may be called with an arbitrary type as first arg, NOT AN INSTANCE of E class; becuase of this, it is misleading to name its first argument self!!</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">E</span>:
    <span style="color:#e6db74">&#34;&#34;&#34;Extension type supporting addition&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">data</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, d):
        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> d
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__add__</span>(x, y):
        <span style="color:#75715e"># Regular __add__ behaviour</span>
        <span style="color:#66d9ef">if</span> isinstance(x, E):
            <span style="color:#66d9ef">if</span> isinstance(y, int):
                <span style="color:#66d9ef">return</span> (&lt;<span style="color:#66d9ef">E</span>&gt;x)<span style="color:#f92672">.</span>data <span style="color:#f92672">+</span> y
        <span style="color:#75715e"># __radd__ behaviour</span>
        <span style="color:#66d9ef">elif</span> isinstance(y, E):
            <span style="color:#66d9ef">if</span> isintance(x, int):
                <span style="color:#66d9ef">return</span> (&lt;<span style="color:#66d9ef">E</span>&gt;y)<span style="color:#f92672">.</span>data <span style="color:#f92672">+</span> x
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> NotImplemented
            
<span style="color:#75715e"># shell</span>
e <span style="color:#f92672">=</span> special_method<span style="color:#f92672">.</span>E(<span style="color:#ae81ff">100</span>)
<span style="color:#75715e"># takes first branch of E.__add__</span>
e <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 101</span>
<span style="color:#75715e"># second branch</span>
<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> e <span style="color:#75715e"># 101</span>
<span style="color:#75715e"># error: E.__add__ returns last branch, built-in type float tries to do an __radd__ with an E instances as left argument. NOT knowing how to add itself to an E object, it again returns last branch, </span>
e <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.0</span> <span style="color:#75715e"># TypeError</span>
    
<span style="color:#75715e"># One more case: float&#39;s __add__ called, realised it did not know how to handle E instances, returned NotImplemented. Python then called E.__add__(1.0, e) (or equi-else), which also returned NotImplemented, causing raise TypeError</span>
<span style="color:#ae81ff">1.0</span> <span style="color:#f92672">+</span> e <span style="color:#75715e"># TypeError</span>
    
<span style="color:#75715e"># Note</span>
<span style="color:#75715e"># The in-place operations like __iadd__ always take an instance of the class as the first</span>
<span style="color:#75715e"># argument, so self is an appropriate name in these cases. The exception to this is</span>
<span style="color:#75715e"># __ipow__ , which may be called with a different order of arguments, like __add__ .</span>
</code></pre></div><ul>
<li><strong>Cython does not auto-type either arg to <code>__add__</code>, making the <code>isinstance</code> chcek and cast necessary to access each E instances's internal .data attribute.</strong></li>
</ul>
</li>
</ul>
<h3 id="rich-comparisons">Rich Comparisons</h3>
<ul>
<li>
<p>no <code>__eq__, __lt__, __le__</code> but a SINGLE, cryptic <code>__richcmp__(x, y, op)</code> taking an integer third arg to specify which comparison ops to perform</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">from</span> cpython.object <span style="color:#66d9ef">cimport</span> Py_LT, Py_LE, Py__EQ, Py_GE, Py_GT, Py_NE
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">R</span>:
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">data</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, d):
        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> d
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__richcmp__</span>(x, y, int op):
        <span style="color:#66d9ef">cdef</span>:
            R r <span style="color:#75715e"># interesting, declare its own cls ?</span>
            double data
    <span style="color:#75715e"># Make r always refer to R instance</span>
    r, y <span style="color:#f92672">=</span> (x, y) <span style="color:#66d9ef">if</span> isinstance(x, R) <span style="color:#66d9ef">else</span> (y, x)
        
    data <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>data
    <span style="color:#66d9ef">if</span> op <span style="color:#f92672">==</span> Py_LT:
        <span style="color:#66d9ef">return</span> data <span style="color:#f92672">&lt;</span> y
    <span style="color:#66d9ef">elif</span> op <span style="color:#f92672">==</span> Py_LE:
        <span style="color:#66d9ef">return</span> data <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> y
    <span style="color:#66d9ef">elif</span> op <span style="color:#f92672">==</span> Py_EQ:
        <span style="color:#66d9ef">return</span> data <span style="color:#f92672">==</span> y
    <span style="color:#66d9ef">elif</span> op <span style="color:#f92672">==</span> Py_NE:
        <span style="color:#66d9ef">return</span> data <span style="color:#f92672">!=</span> y
    <span style="color:#66d9ef">elif</span> op <span style="color:#f92672">==</span> Py_GT:
        <span style="color:#66d9ef">return</span> data <span style="color:#f92672">&gt;</span> y
    <span style="color:#66d9ef">elif</span> op <span style="color:#f92672">==</span> Py_GE:
        <span style="color:#66d9ef">return</span> data <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> y
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">assert</span> False
            
<span style="color:#75715e"># SPECIAL CHAIN COMPARE:</span>
<span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> r <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#75715e"># True</span>
</code></pre></div></li>
</ul>
<h3 id="iterator">Iterator</h3>
<ul>
<li>
<p><code>__iter__</code> makes object iterable</p>
</li>
<li>
<p><code>__next__</code> makes iterator</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">I</span>:
    <span style="color:#66d9ef">cdef</span>:
        list data
        int i
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> range(<span style="color:#ae81ff">100</span>)
        self<span style="color:#f92672">.</span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__iter__</span>(self):
        <span style="color:#66d9ef">return</span> self
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__next__</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>i <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>data):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">StopIteration</span>()
        set <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>data[self<span style="color:#f92672">.</span>i]
        self<span style="color:#f92672">.</span>i <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">return</span> ret
        
<span style="color:#75715e"># I defines __iter__, can be used in for loops</span>
<span style="color:#66d9ef">from</span> special_methods <span style="color:#66d9ef">import</span> I
i <span style="color:#f92672">=</span> I()
s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> i:
    s <span style="color:#f92672">+</span><span style="color:#f92672">=</span> x
    
<span style="color:#75715e"># iterator</span>
it <span style="color:#f92672">=</span> iter(I())
it<span style="color:#f92672">.</span>next() <span style="color:#75715e"># 0</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<p>SUMMARY</p>
<p>CYTHON MELDS EXT_TYPE DEFINITION</p>
<ol>
<li>allows easy and fast access to an instance's C data and methods</li>
<li>memory efficient</li>
<li>allows control over attribute visibility</li>
<li>can be subclassed from Python</li>
<li>workds with existing built-in types and other extension types</li>
</ol>
<p>USE: TO WRAP C STRUCTS, FUNCTIONS, AND C++ CLASSES TO PROVIDE NICE OBJECT-ORIENTED INTERFACES TO EXTERNAL LIBRARIES.</p>
<h1 id="chapter-6-organising-cython-code">Chapter 6: Organising Cython Code</h1>
<ul>
<li>Cython <code>import</code> allows RUNTIME access Python objects DEFINED in external Python modules or Python-accessible objects DEFINED in other extension modules!</li>
<li>If that was it: would not allow two Cython modules to access each other's cdef or cpdef functoins, ctypedefs, structs, nor allow C access to other extension types!</li>
<li>SO: 3-FILE types to organise Cython-specfic and C parts of a project</li>
<li>IMPLEMENTATION FILE - <code>.pyx</code></li>
<li>DEFINITION FILE - <code>.pxd</code></li>
<li>INCLUDE FILE - <code>.pxi</code></li>
<li><code>cimport</code> for COMPILE-TIME access to C constructs, looking for their declarations inside <code>.pxd</code> files</li>
</ul>
<h2 id="declaration-file">Declaration File</h2>
<ul>
<li>
<p>need for sharing <code>pyx</code> C constructs</p>
</li>
<li>
<p>Example of Simulator.pyx:</p>
<ul>
<li><code>ctypedef</code></li>
<li><code>cdef</code> class named State to hold simulation state</li>
<li>Two <code>def</code>, setup and output, to init and to report or visualise results</li>
<li>Two <code>cpdef</code>, run and step, to drive the simulation and advance one time step</li>
</ul>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># simulator.pyx</span>
<span style="color:#66d9ef">ctypedef</span> double real_t
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">State</span>:
    <span style="color:#66d9ef">cdef</span>:
        unsigned int n_particles
        real_t <span style="color:#f92672">*</span>x
        real_t <span style="color:#f92672">*</span>vx
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__cinit__</span>(<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>):
        <span style="color:#75715e"># ...</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__dealloc__</span>(<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>):
        <span style="color:#75715e"># ...</span>
  <span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">real_t</span> <span style="color:#a6e22e">momentum</span>(self):
        <span style="color:#75715e"># ...</span>
          
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setup</span>(input_fname):
    <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">cpdef</span> <span style="color:#a6e22e">run</span>(State st):
    <span style="color:#75715e"># ... calls step func repeatedly</span>
<span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">step</span>(State st, real_t timestep):
    <span style="color:#75715e"># ... advance st one time step...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">output</span>(State st):
    <span style="color:#75715e"># ...</span>
</code></pre></div><ul>
<li>all in one file, calling cpdef run will access fast C bypassing Python wrapper</li>
<li>AS SIMULATOR EXT_MODULE GAINS MORE FUNCTIONALITY, BECOMES HARDER TO MAINTAIN</li>
<li>To make it modular, need to break it up into logical subcomponents !</li>
</ul>
</li>
<li>
<p>First create <code>simulator.pxd</code> definition file holding declaration C constructs to share</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># simulator.pxd</span>
<span style="color:#66d9ef">ctypedef</span> double real_t
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">State</span>:
    <span style="color:#66d9ef">cdef</span>:
        unsigned int n_particles
        real_t <span style="color:#f92672">*</span>x
        real_t <span style="color:#f92672">*</span>vx
          
  <span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">real_t</span> <span style="color:#a6e22e">momentum</span>(self)
      
<span style="color:#66d9ef">cpdef</span> <span style="color:#a6e22e">run</span>(State st)
  
<span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">step</span>(State st, real_t timestep)
</code></pre></div><ul>
<li>because definition files (header files?) are meant for compile-time access, note that we put ONLY C declarations in it. These functions are accessible at runtime, so they are just declared and defined inside implementation file.</li>
<li>implementation files need change, since base name the same <code>simulator.*</code>,  they are treated as ONE NAMESPACE by Cython - CANNOT repeat any of declaractions in implementation file - compile error</li>
</ul>
</li>
</ul>
<h3 id="declarations-and-definitions">Declarations and Definitions</h3>
<ul>
<li>Syntactically, declaration for a function or method includes everything for the fucntion or method's SIGNATURE:
<ul>
<li>the declaration type (<code>cdef, cpdef</code>);</li>
<li>the function or methods&rsquo; name;</li>
<li>all in the arg list.</li>
<li>NOT terminating colon.</li>
</ul>
</li>
<li>For cdef class, the declaration includes
<ul>
<li>cdef class line (colon included) and</li>
<li>extension types&rsquo; name,</li>
<li>all attribute declarations and</li>
<li>all method declarations</li>
</ul>
</li>
<li>Cython definition is all required for that construct's implementation. The definition for a function or method repeats the declaration as part of the definition (i.e., the implementation); the definition for a <code>cdef</code> class does not redeclare the attribute declarations</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># simulator.pyx</span>

<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">State</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__cinit__</span>(<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>):
        <span style="color:#75715e"># ...</span>
	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__dealloc__</span>(<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>):
        <span style="color:#75715e"># ...</span>
	<span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">real_t</span> <span style="color:#a6e22e">momentum</span>(self):
        <span style="color:#75715e"># ...</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setup</span>(input_fname):
    <span style="color:#75715e">#...</span>
<span style="color:#66d9ef">cpdef</span> <span style="color:#a6e22e">run</span>(State st):
	<span style="color:#75715e"># ...calls step function repeatedly...</span>
<span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">step</span>(State st, real_t timestep):
	<span style="color:#75715e"># ...advance st one time step...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">output</span>(State st):
    <span style="color:#75715e">#...</span>
</code></pre></div><ul>
<li><code>ctypedef</code> and State type's attributes have been moved to the definition file, so they are removed from the implementation file. The definitions of all objects, whether C or Python, go inside the implementation file.</li>
<li><strong>Cython compiler will auto-use definition files&rsquo; declarations!</strong></li>
<li>What's in DEFINITION FILE: <strong>anything meant to be publicly accessible to other Cython modules at C level</strong>
<ul>
<li>C type declarations - <code>ctypedef, struct, union, enum</code></li>
<li>Declarations for external C or C++ libs (<code>cdef extern</code> blocks)</li>
<li>Declarations for <code>cdef, cpdef</code> module-level functions</li>
<li>Declarations for <code>cdef class</code> extensions types</li>
<li><code>cdef</code> attributes of extension types</li>
<li>Declarations for <code>cdef, cpdef</code> methods</li>
<li>Implementation of C-level <code>inline</code> functions and methods</li>
</ul>
</li>
<li>CANNOT contain
<ul>
<li>implementation of Python or non-inline C functions or methods</li>
<li>Python class definition</li>
<li>Executables Python code outside of <code>IF, DEF</code> macros</li>
</ul>
</li>
<li>Now an external implementation file can access all C-level constructs inside simulator.pyx via <code>cimport</code> statement</li>
</ul>
<h2 id="cimport-statement">cimport Statement</h2>
<ul>
<li>
<p>suppose another improved <code>.pyx</code> need <code>setup, step</code> functions but a different <code>run</code> need to subclass <code>State</code> extension type:</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># imp_simulator.pyx</span>
<span style="color:#66d9ef">from</span> simulator <span style="color:#66d9ef">cimport</span> State, step, real_t
<span style="color:#66d9ef">from</span> simulator <span style="color:#66d9ef">import</span> setup <span style="color:#66d9ef">as</span> sim_setup
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NewState</span>(State):
    <span style="color:#66d9ef">cdef</span>:
        <span style="color:#75715e"># ... extra attributes...</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__cinit__</span>(self, <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>):
        <span style="color:#75715e"># ...</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__dealloc__</span>(self):
        <span style="color:#75715e"># ...</span>
  
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setup</span>(fname):
    <span style="color:#75715e"># ... call sim_setup and tweak things slightly ...</span>
      
<span style="color:#66d9ef">cpdef</span> <span style="color:#a6e22e">run</span>(State st):
    <span style="color:#75715e"># ... improved run taht uses simulator.step ...</span>
</code></pre></div><ul>
<li>
<p>first line uses cimport statement to access the State extension type, the step cpdef function, and the real_t ctypedef</p>
<ul>
<li>
<p><strong>this access is at C level and occurs at compile time</strong></p>
</li>
<li>
<p>only declarations in definition file are <code>cimport</code>able</p>
</li>
<li>
<p>constrast to second line which uses import to access the setup def from extension module; works at Python level and import occurs at runtime</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cimport</span> simullator <span style="color:#75715e"># pxd file</span>
<span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">simulator</span>.<span style="color:#66d9ef">State</span> <span style="color:#a6e22e">st</span> <span style="color:#f92672">=</span> simulator<span style="color:#f92672">.</span>State(params)
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">simulator</span>.<span style="color:#66d9ef">real_t</span> <span style="color:#a6e22e">dt</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>
simulator<span style="color:#f92672">.</span>step(st, dt)
      
<span style="color:#75715e"># can provide an alias when cimport definition file</span>
<span style="color:#66d9ef">cimport</span> simulator <span style="color:#66d9ef">as</span> sim
      
<span style="color:#75715e"># ....</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">sim</span>.<span style="color:#66d9ef">State</span> <span style="color:#a6e22e">st</span> <span style="color:#f92672">=</span> sim<span style="color:#f92672">.</span>State(params)
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">sim</span>.<span style="color:#66d9ef">real_t</span> <span style="color:#a6e22e">dt</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>
sim<span style="color:#f92672">.</span>step(st, dt)
      
<span style="color:#75715e"># also provide alias to specific cimported declarations with as </span>
<span style="color:#66d9ef">from</span> simulator <span style="color:#66d9ef">cimport</span> State <span style="color:#66d9ef">as</span> sim_state, step <span style="color:#66d9ef">as</span> sim_step
</code></pre></div></li>
</ul>
</li>
<li>
<p>compile-time error to cimport a Python-level object like setup function</p>
</li>
<li>
<p>reverse, compile-time error to import C-only declaration like real_t</p>
</li>
<li>
<p>Allowed to import or cimport State extension type or the step cpdef function, although cimport is recommended</p>
</li>
<li>
<p>if import rather than cimport extension types or cpdef functions, would have Python-only access</p>
</li>
<li>
<p>This blocks access to any private attributes or cdef methods, and cpdef methods and functions use the slower Python wrapper</p>
</li>
<li>
<p>Def file can contain <code>cdef extern</code> blocks, useful to gropu such declarations inside their own <code>.pxd</code> files for use elsewhere, doing so provides a useful namespace to help disambiguate where a function is declared</p>
</li>
<li>
<p>e.g. the Mersenne Twister random-number generator RNG header file has a few funcs that can be declared inside a <code>_mersenne_twister.pdx</code> definition file:</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mt19937ar.h</span><span style="color:#e6db74">&#34;</span>:
    <span style="color:#75715e"># init mt[N] with a seed</span>
    void init_genrand(unsigned long s)
        
    <span style="color:#75715e"># gen a random number on [0, 0xffffffff]-interval</span>
    unsigned long genrand_int32()
        
    <span style="color:#75715e"># gen a random number on [0, 0x7fffffff]-interval</span>
    long genrand_int31()
<span style="color:#75715e"># generates a random number on [0,1]-real-interval</span>
double genrand_real1()
<span style="color:#75715e"># generates a random number on [0,1)-real-interval</span>
double genrand_real2()
<span style="color:#75715e"># generates a random number on (0,1)-real-interval</span>
double genrand_real3()
<span style="color:#75715e"># generates a random number on [0,1) with 53-bit resolution</span>
double genrand_res53()
</code></pre></div><ul>
<li>now any implementation file can simply cimport the necessary function:</li>
<li><code>from _mersenne_twister cimport init_genrand, genrand_real3</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="predefined-definition-files">Predefined Definition Files</h2>
<ul>
<li>Cython comes with several predefined definition files for oft-used C, C++ and Python header files</li>
<li><code>Includes</code> dir underneath main Cython source dir</li>
<li><code>libc</code> contains <code>.pxd</code> files for the <code>stdlib, stdio, math, string, stdint</code> header files</li>
<li><code>libcpp</code> package with <code>.pxd</code> files of STL, <code>string, vector, list, map, pair, set</code></li>
<li><code>numpy</code> file for Numpy/C API</li>
</ul>
<h3 id="using-cimport-with-a-module-in-a-package">Using cimport with a module in a package</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">from</span> libc <span style="color:#66d9ef">cimport</span> math
math<span style="color:#f92672">.</span>sin(<span style="color:#ae81ff">3.14</span>)

<span style="color:#75715e"># cimport imports module-like math namespace from libc packages allowing dotted access</span>
<span style="color:#75715e"># C funcs declared in math.h C standard library</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># multiple named cimports</span>

<span style="color:#66d9ef">from</span> libc.stdlib <span style="color:#66d9ef">cimport</span> rand, srand, qsort, malloc, free
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> *<span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>int<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>malloc(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> sizeof(int))

<span style="color:#66d9ef">from</span> libc.string <span style="color:#66d9ef">cimport</span> memcpy <span style="color:#66d9ef">as</span> c_memcpy

<span style="color:#66d9ef">from</span> libcpp.vector <span style="color:#66d9ef">cimport</span> vector
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">vector</span>[<span style="color:#66d9ef">int</span>] *<span style="color:#a6e22e">vi</span> <span style="color:#f92672">=</span> new vector[int](<span style="color:#ae81ff">10</span>)

<span style="color:#75715e"># invalid same namespace</span>
</code></pre></div><ul>
<li>Definition files have some similarities to C/C++ header files
<ul>
<li>declare C-level constructs for use by external code</li>
<li>allow us to break up what would be one large file into several components</li>
<li>declare the public C-level interface for an implementation</li>
</ul>
</li>
<li><strong>C/C++ access header files via the #include preprocessor command, which essentially does a dumb source-level inclusion of the named header file</strong></li>
<li><strong>Cython's cimport statement is more intelligent and less error prone: think of it as a compile-time import statement that works with namespaces!</strong></li>
<li>Cython's predecessor, Pyrex, did not have cimport statement, and instead had an include for source-level inclusion of an external include file. Cython also supports the include statement and include files, which are used in several Cython projects</li>
</ul>
<h2 id="include-files-and-include-statement">Include Files and Include Statement</h2>
<ul>
<li>
<p>suppose an extension type that we want available on all major platforms, but it must be implemented differently on different platforms.</p>
</li>
<li>
<p>Goal is to abstract away these differences and to provide a consistent interface in a transparent way - include files and the include statement provide one way to accomplish our nice platform-free design goals</p>
</li>
<li>
<p>Place 3 different implementations of the extension type in 3 <code>.pxi</code> files</p>
<ul>
<li>
<p><code>linux.pxi, darwin.pxi, windows.pxi</code></p>
</li>
<li>
<p>one of the three will be selected and used at compile time</p>
</li>
<li>
<p>inside <code>interface.pyx</code></p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e">IF</span> UNAME_SYSNAME <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Linux</span><span style="color:#e6db74">&#34;</span>:
    <span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">linux.pxi</span><span style="color:#e6db74">&#34;</span>
<span style="color:#75715e">ELIF</span> <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="organising-and-compiling-cython-modules-inside-python-packages">Organising and Compiling Cython Modules Inside Python Packages</h2>
<ul>
<li>
<p>INCREMENTALLY CONVERT PYTHON CODE TO CYTHON</p>
</li>
<li>
<p>allowing external API remain intact while overall performance improves</p>
</li>
<li>
<p>example of Python pysimulator</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">__init__.py
main.py
core
    __ini__.py
    core.py
    sim_state.py
plugins
    __init__.py
    plugin0.py
    plugin1.py
utils
    __init__.py
    config.py
    output.py
</code></pre></div></li>
<li>
<p>focus for this example is not the internal details of the pysimulator modules; it's how Cython modules can access compile-time declarations and work easily within the framework of a Python project</p>
</li>
<li>
<p>suppose profiling reveals <code>core.py, sim_state.py, plugin0.py</code> are slow</p>
</li>
<li>
<p><code>sim_state.py</code> module contains State class that will convert into extension type</p>
</li>
<li>
<p><code>core.py</code> contains two funcs, run and step, that will convert to <code>cpdef</code></p>
</li>
<li>
<p><code>plugin0.py</code> contains run also convert into <code>cpdef</code> func</p>
</li>
</ul>
</li>
<li>
<p>first to convert .py modules into implementation files and extract their <strong>public Cython declarations into definitions files</strong> ; because components are spread out in diff packages and subpackages, must remember to use proper qualified names for importing</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># sim_state.pxd</span>
<span style="color:#66d9ef">ctypedef</span> double real_t
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">State</span>:
    <span style="color:#66d9ef">cdef</span>:
        unsigned int n_particles
        real_t <span style="color:#f92672">*</span>x
        real_t <span style="color:#f92672">*</span>vx
          
  <span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">real_t</span> <span style="color:#a6e22e">momemtum</span>(self)
  
<span style="color:#75715e"># all `cpdef` takes `State` instance, need C-level access - so all modules will have to `cimport` the `State` declarationfrom appropriate definition file</span>

<span style="color:#75715e"># core.pxd declares the `run, step` cpdef </span>
<span style="color:#66d9ef">from</span> simulator.core.sim_state <span style="color:#66d9ef">cimport</span> State, real_t
  
<span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">run</span>(State, list plugins<span style="color:#f92672">=</span>None)
<span style="color:#66d9ef">cpdef</span> <span style="color:#a6e22e">step</span>(State st, real_t dt)
  
<span style="color:#75715e"># `cimport` is ABSOLUTE, using fully qualified name to access for clarity</span>
  
<span style="color:#75715e"># plugin0.pxd declares its own `run cpdef` takes State instance</span>
<span style="color:#66d9ef">from</span> simulator.core.sim_state <span style="color:#66d9ef">cimport</span> State
  
<span style="color:#66d9ef">cpdef</span> <span style="color:#a6e22e">run</span>(State st)
  
<span style="color:#75715e"># main.py - pure Python, like all inside `utils` subpackage - pulls all together</span>
<span style="color:#66d9ef">from</span> simulator.utils.config <span style="color:#66d9ef">import</span> setup_params
<span style="color:#66d9ef">from</span> simulator.utils.output <span style="color:#66d9ef">import</span> output_state
<span style="color:#66d9ef">from</span> simulator.core.sim_state <span style="color:#66d9ef">import</span> State
<span style="color:#66d9ef">from</span> simulator.core.core <span style="color:#66d9ef">import</span> run
<span style="color:#66d9ef">from</span> simulator.plugins <span style="color:#66d9ef">import</span> plugin0
  
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(fname):
    params <span style="color:#f92672">=</span> setup_params(fname)
    state <span style="color:#f92672">=</span> State(params)
    output_state(state)
    run(state, plugins<span style="color:#f92672">=</span>[plugin0<span style="color:#f92672">.</span>run])
    output_state(state)
      
<span style="color:#75715e"># main.py module remains unchanged after Cyhon conversions, as do any other pure-Python modules in project - Cython allows surgically replacing individual components with extension modules, and rest intact</span>
</code></pre></div></li>
<li>
<p>to run, first <strong>compile</strong> Cython source into extension modules - pyximport on-the-fly during dev and testing</p>
</li>
<li>
<p><code>import pyximport; pyximport.install(); from simulator.main import main</code></p>
</li>
<li>
<p>imported all extension modules, pyximport compiled them auto</p>
</li>
<li>
<p><code>main(&quot;params.txt&quot;)</code> =&gt; output indicating process, steps,</p>
</li>
<li>
<p>create distributable compiled package - <code>distuils</code> or other build system</p>
</li>
<li>
<p>minimum <code>setup.py</code></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> distutils.core <span style="color:#f92672">import</span> setup
<span style="color:#f92672">from</span> Cython.Build <span style="color:#f92672">import</span> cythonize
  
setup(name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">simulator</span><span style="color:#e6db74">&#34;</span>,
      packages<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">simulator</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">simulator.core</span><span style="color:#e6db74">&#34;</span>,
                  <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">simulator.utils</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">simulator.plugins</span><span style="color:#e6db74">&#34;</span>],
      ext_modules<span style="color:#f92672">=</span>cythonize(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">**/*.pyx</span><span style="color:#e6db74">&#34;</span>),
     )
</code></pre></div></li>
<li>
<p>cythonize glob pattern to recursively search all dir for <code>.pyx</code> implementation files and compile them as needed - this way is flexible and powerful - auto-detect when a <code>.pyx</code> file has changed and recompile as needed - also detect interdependencies between implementation and definition files and recompile all dependent implementation files</p>
</li>
<li>
<p>In sum, 3-file types, in conjunction with <code>cimport, include</code> allows organising code into separate moduels and packages, without sacrificing performance - allowing Cython to expand beyond speeding up isolated extension modules, to scale full-fledged projects</p>
</li>
</ul>
<h1 id="chapter-7-wrapping-c">Chapter 7: Wrapping C</h1>
<ul>
<li>both way - makes C-level Cython constructs for external C code, useful when embedding Python in C app</li>
<li>Cython allows full control over all aspects during interfacing</li>
<li>Final outcome: C-speed, minimal wrapper overhead, Pythonic interface</li>
</ul>
<h2 id="declaring-external-c-code-in-cython">Declaring External C code in Cython</h2>
<ul>
<li>
<p>First must declare C interface components in Cython <code>extern</code> block</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">header_name</span><span style="color:#e6db74">&#34;</span>:
    indented declarations <span style="color:#66d9ef">from</span> header file
</code></pre></div><ul>
<li>cython compiler generates an <code>#include &quot;header_name&quot;</code> line inside the generated source file</li>
<li>the types, funcs, and other declarations made in block body are accessible from Cython</li>
<li>Cython will check at compile time that C declarations are used in <code>type-correct manner</code>, will prodce error if not</li>
</ul>
</li>
<li>
<p>Declarations in extern block have C-like syntax for variables/funcs, Cython-specific syntax for declaring <code>structs, unions</code></p>
</li>
</ul>
<blockquote>
<p><strong>Bare extern Declarations</strong> - Cython supports extern <code>cdef extern external_declaration</code>, used in this manner, Cython will place it (func signature, variable, struct, union or other such C declaration) in the generated source code with extern modifier - must match C declaration</p>
<p>This style of external declaration is not recommended, as it has the same drawbacks as using extern in C directly, <code>extern</code> block is preferred !!</p>
</blockquote>
<ul>
<li>
<p><strong>if necessary to have <code>#include</code> preprocessor directive for a specific header file, but no declarations are required, the block can be empty</strong></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">header.h</span><span style="color:#e6db74">&#34;</span>:
    <span style="color:#66d9ef">pass</span>
</code></pre></div></li>
<li>
<p>conversely, if name of header file not necessary (perhaps it's already included by another header file that has its own extern block), but like to interface with external code, can suppress #include statement generation with from *:</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">*</span>:
    declarations<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div></li>
</ul>
<h2 id="cython-does-not-automate-wrapping">Cython Does NOT Automate Wrapping</h2>
<ul>
<li>purpose of extern block is simple, but c<strong>an be misleading - for ensuring calling and using the declared C functions, variables, structs in type-correct manner</strong></li>
<li>NOT auto-gen wrappers for the declared objects! - only C code generated for the ENTIRE extern block is a single #include &ldquo;header.h&rdquo; line - STILL HAVE TO write <code>def, cpdef</code> (possibly <code>cdef</code>) calling C functions declared in extern block</li>
<li>Pros of Cython C-wrapper
<ul>
<li>highly optimised generated wrapper code</li>
<li>often goal is to customize, improve, simplify or otherwise Pythonize interface</li>
<li>high-level, Pythonic and not limited to domain-specific interfacing commands, making complicated wrapping tasks easier</li>
</ul>
</li>
</ul>
<h2 id="declaring-external-c-func-and-typedefs">Declaring External C Func and typedefs</h2>
<ul>
<li>
<p>most common declarations are C func/<code>typedefs</code> - almost directly from their C equivalents, only mod:</p>
<ul>
<li>change <code>typedef</code> to <code>ctypedef</code></li>
<li>rid of keywords such as <code>restrict, volatile</code></li>
<li>ensure return type and name are declared on a single line</li>
<li>remove line-terminating semicolons</li>
</ul>
</li>
<li>
<p>Possible to break up long func declaration over several lines after opening parenthesis as in Python</p>
</li>
<li>
<p>e.g. C declar and macros</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">define M_PI 3.1415926</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define MAX(a, b) ((a) &gt;= (b) ? (a) : (b))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>  
<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">hypot</span>(<span style="color:#66d9ef">double</span>, <span style="color:#66d9ef">double</span>);
  
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">int</span> integral;
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">double</span> real;
  
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func</span>(integrall, integral, real);
  
real <span style="color:#f92672">*</span><span style="color:#a6e22e">func_arrays</span>(integral[], integral[][<span style="color:#ae81ff">10</span>], real <span style="color:#f92672">*</span><span style="color:#f92672">*</span>);
</code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># Cython declarations for them, bar the macros, nearly copy-paste</span>
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">header.h</span><span style="color:#e6db74">&#34;</span>:
      
    double M_PI
    float MAX(float a, float b)
      
    <span style="color:#75715e"># arg naming is helpful for calling and doc DO IT!</span>
    double hypot(double x, double y)
      
    <span style="color:#66d9ef">ctypedef</span> int integral
    <span style="color:#66d9ef">ctypedef</span> double real
      
    void func(integral a, integral b, real c)
      
    real <span style="color:#f92672">*</span>func_arrays(integral[] i, integral[][<span style="color:#ae81ff">10</span>] j, real <span style="color:#f92672">*</span><span style="color:#f92672">*</span>k)
</code></pre></div></li>
<li>
<p>NOTE for <code>M_PI</code> macro, declared as if it were a global of double - and <code>MAX</code> func-lke macro, declared in Cython as if a regular C func named <code>MAX</code> taking two float return float</p>
</li>
<li>
<p>a more complex header.h</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># C: func named signal taking func-pointer returns func-pointer</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">header.h</span><span style="color:#e6db74">&#34;</span>:
    void (<span style="color:#f92672">*</span>signal(void(<span style="color:#f92672">*</span>)(int)))(int)
    
<span style="color:#75715e"># Cython uses extern blocks ONLY to check type correctness, can add helper `ctypedef` for legibility</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">header.h</span><span style="color:#e6db74">&#34;</span>:
    <span style="color:#66d9ef">ctypedef</span> void (<span style="color:#f92672">*</span>void_int_fptr)(int)
    void_int_fptr signal(void_int_fptr)
        
<span style="color:#75715e"># easier to read, as Cython does NOT declare void_int_ptr typedef in generated code, can use it to help make C simpler - void_int_fptr ctypedefs ONLY a Cython convenience, no corresponding typedef in header file!</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h2 id="declaring-and-wrapping-c-structs-unions-enums">Declaring and Wrapping C structs, unions, enums</h2>
<ul>
<li>
<p>same syntax as before, but omit <code>cdef</code> as it's implied</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">header_name</span><span style="color:#e6db74">&#34;</span>:
        
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">struct_name</span>:
        struct_members
    union <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
    enum <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// above translate to C
</span><span style="color:#75715e"></span>    
<span style="color:#66d9ef">struct</span> struct_name {
    struct_members
};
    
<span style="color:#75715e">// for typedef verions in C
</span><span style="color:#75715e"></span>    
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> struct_name {
    struct_members
} struct_alias;
    
<span style="color:#75715e">// same for union and enum
</span></code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">header_name</span><span style="color:#e6db74">&#34;</span>:
        
    <span style="color:#66d9ef">ctypedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">struct_alias</span>:
        struct_members
</code></pre></div></li>
<li>
<p>Cython uses just the alias type names and NOT generate struct, union, enum as part of declaration as is proper</p>
</li>
<li>
<p>to STATICALLY declare a struct in Cython, use <code>cdef</code> with struct name or <code>typedef</code> alias name;</p>
</li>
<li>
<p>ONLY necessary to declare fields ACUTALLY used in preceding struct, etc. if no fields are used but it is necessary to use struct as opaque type, then body should be <code>pass</code></p>
</li>
</ul>
</li>
</ul>
<h2 id="wrapping-c-functions">Wrapping C Functions</h2>
<ul>
<li>
<p><strong>after declaring external func, MUST wrap in <code>def</code> , <code>cpdef</code> or <code>cdef</code> class to access from Python</strong></p>
</li>
<li>
<p>e.g. wrap a RNG, two exposure, 1) <code>init_genrand</code> and <code>genrand_real1</code></p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># declare them in Cython</span>
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mt19937ar.h</span><span style="color:#e6db74">&#34;</span>:
    void init_genrand(unsigned long s)
    double genrand_real1()
      
<span style="color:#75715e"># MUST provide def / cpdef so that these callable from Python</span>
  
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init_state</span>(unsigned long s):
    init_genrand(s)
      
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rand</span>():
    <span style="color:#66d9ef">return</span> genrand_real1()
  
<span style="color:#75715e"># to compile all, write setup.py (make sure to include header in sources)</span>
  
<span style="color:#66d9ef">from</span> distutils.core <span style="color:#66d9ef">import</span> setup, Extension
<span style="color:#66d9ef">from</span> Cython.Build <span style="color:#66d9ef">import</span> cythonize
  
ext <span style="color:#f92672">=</span> Extension(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mt_random</span><span style="color:#e6db74">&#34;</span>,
                  sources<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mt_random.pyx</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mt19937ar.c</span><span style="color:#e6db74">&#34;</span>])
  
setup(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mersenne_random</span><span style="color:#e6db74">&#34;</span>,
      ext_modules <span style="color:#f92672">=</span> cythonize([ext]))
  
</code></pre></div></li>
<li>
<p><code>python setup.py build_ext --inplace</code></p>
</li>
<li>
<p>output: <code>mt_random.so</code> or <code>mt_random.pyd</code> depending on OS</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># use it in IPython</span>
  
mt_random.init_state<span style="color:#f92672">(</span>42<span style="color:#f92672">)</span>
  
mt_random.rand<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#75715e"># 0.37....</span>
</code></pre></div></li>
<li>
<p>CONS: uses a STATIC GLOBAL array to store RNG state, allowing only ONE RNG a time</p>
</li>
<li>
<p>next version supports concurrent generators</p>
</li>
</ul>
<h2 id="wrapping-c-structs-with-extension-types">Wrapping C structs with Extension Types</h2>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// mt19937ar-struct.h
</span><span style="color:#75715e"></span><span style="color:#75715e">// improved API first forward-decalres a struct typedef in header file
</span><span style="color:#75715e"></span>  
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _mt_state mt_state;
  
<span style="color:#75715e">// declares creation and destruction
</span><span style="color:#75715e"></span>  
mt_state <span style="color:#f92672">*</span><span style="color:#a6e22e">make_mt</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> s);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">free_mt</span>(mt_state <span style="color:#f92672">*</span>state);
  
<span style="color:#75715e">// RNG func take a pointer to a heap-alloc mt_state struct as arg, wrap just one of them
</span><span style="color:#75715e"></span>  
<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">genrand_real1</span>(mt_state <span style="color:#f92672">*</span>state);
</code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># cython declaration for new API</span>
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mt19937ar-struct.h</span><span style="color:#e6db74">&#34;</span>:
    <span style="color:#66d9ef">ctypedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">mt_state</span>
    mt_state <span style="color:#f92672">*</span>make_mt(unsigned long s)
    void free_mt(mt_state <span style="color:#f92672">*</span>state)
    double genrand_real1(mt_state <span style="color:#f92672">*</span>state)
</code></pre></div></li>
<li>
<p>because mt_state struct is opaque and Cython does not need to access any of its internal fields, the preceding ctypedef is sufficient ! essentially a named placeholder</p>
</li>
<li>
<p>cython exposes none of these C extern declarations to Python - it's nice to wrap this imp-version in an extension type named MT, the only attribute will hold is a private pointer to an mt_state struct:</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MT</span>:
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">mt_state</span> *<span style="color:#a6e22e">_thisptr</span>
    <span style="color:#75715e"># creating mt_state heap-alloc struct MUST in C-level before MT object init</span>
    <span style="color:#75715e"># proper place to do it is in __cinit__</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__cinit__</span>(self, unsigned long s):
        self<span style="color:#f92672">.</span>_thisptr <span style="color:#f92672">=</span> make_mt(s)
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_thisptr <span style="color:#f92672">==</span> NULL:
            msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Insufficient memory.</span><span style="color:#e6db74">&#34;</span>
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">MemoryError</span>(msg)
    <span style="color:#75715e"># deconstructor</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__dealloc__</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_thisptr <span style="color:#f92672">!=</span> NULL:
            free_mt(self<span style="color:#f92672">.</span>_thisptr)
                
    <span style="color:#75715e"># these methods allow proper create, init, free MT object</span>
    <span style="color:#75715e"># to RNG, simply define def / cpdef calling the C fucntions</span>
    <span style="color:#66d9ef">cpdef</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">rand</span>(self):
        <span style="color:#66d9ef">return</span> genrand_real1(self<span style="color:#f92672">.</span>_thisptr)
</code></pre></div></li>
<li>
<p>declaring and interfacing the remaining funcs is left as exercise</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># setup_mt_type.py</span>
    
<span style="color:#f92672">from</span> distuils.core <span style="color:#f92672">import</span> setup, Extension
<span style="color:#f92672">from</span> Cython.Build <span style="color:#f92672">import</span> cythonize
    
ext_type <span style="color:#f92672">=</span> Extension(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mt_random_type</span><span style="color:#e6db74">&#34;</span>,
                     sources<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mt_random_type.pyx</span><span style="color:#e6db74">&#34;</span>,
                              <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mt19937ar-struct.c</span><span style="color:#e6db74">&#34;</span>])
    
setup(name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mersenne_random</span><span style="color:#e6db74">&#34;</span>,
      ext_modules <span style="color:#f92672">=</span> cythonize([ext_type]))
</code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">python setup_mt_type.py build_ext --inplace
    
from mt_random_type import MT
    
mt1, mt2 <span style="color:#f92672">=</span> MT<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>, MT<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>
    
mt1.rand<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> mt2.rand<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#75715e"># True</span>
</code></pre></div></li>
</ul>
<blockquote>
<p>For wrapping C structs in Cython, the pattern used in this example is common and
recommended. The internal struct pointer is kept private and used only internally. The
struct is allocated and initialized in <strong>cinit</strong> and automatically deallocated in
<strong>dealloc</strong> . Declaring methods cpdef when possible allows them to be called by ex‐
ternal Python code, and efficiently from other Cython code. It also allows these methods
to be overridden in Python subclasses.</p>
</blockquote>
</li>
</ul>
<h2 id="more-control---constant-modifier-output">More Control - constant, modifier, output</h2>
<ul>
<li>
<p><code>const</code> not useful in <code>cdef</code> but IS in specific instances within <code>cdef extern</code> to ensure Cython generates const-correct code</p>
</li>
<li>
<p>NOT necessary for declaring func arg, may be required when declaring a <code>typedef</code> using <code>const</code> or return one</p>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span> const_int_ptr;
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">double</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">returns_ptr_to_const</span>(const_int_ptr);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># forward to .pyd</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">header.h</span><span style="color:#e6db74">&#34;</span>:
    <span style="color:#66d9ef">ctypedef</span> const int <span style="color:#f92672">*</span> const_int_ptr
    const double <span style="color:#f92672">*</span>returns_ptr_to_const(const_int_ptr)
</code></pre></div></li>
<li>
<p>modifiers <code>volatile, restrict</code> should be removed in Cython</p>
</li>
<li>
<p>naming C level objects differently</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># wrap C print - cannot use print as reserved - aliasing</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">printer.h</span><span style="color:#e6db74">&#34;</span>:
    void _print <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">print</span><span style="color:#e6db74">&#34;</span>(fmt_str, arg)
        
<span style="color:#75715e"># named _print in Cython, but print in generated C, also works for typedef/struct/etc</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">pathological.h</span><span style="color:#e6db74">&#34;</span>:
    <span style="color:#75715e"># typedef void * class</span>
    <span style="color:#66d9ef">ctypedef</span> void <span style="color:#f92672">*</span> kclass <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">class</span><span style="color:#e6db74">&#34;</span>
        
    <span style="color:#75715e"># int finally(void) function</span>
    int _finally <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">finally</span><span style="color:#e6db74">&#34;</span>()
        
    <span style="color:#75715e"># struct del { int a, b; };</span>
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_del</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">del</span><span style="color:#e6db74">&#34;</span>:
        int a, b
            
    <span style="color:#75715e"># enum yield { ALOT; SOME; ALITTLE; };</span>
    enum _yield <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yield</span><span style="color:#e6db74">&#34;</span>:
        ALOT
        SOME
        ALITTLE
</code></pre></div></li>
<li>
<p><strong>string in quotes is the name of object in generated C code, Cython does no checking on content of this string</strong></p>
</li>
</ul>
</li>
</ul>
<h2 id="error-exception---callback">Error Exception - Callback</h2>
<ul>
<li>
<p><code>except</code> clause can be used in conjunction with <code>cdef</code> callback</p>
</li>
<li>
<p>Cython supports C func-pointer - allow wrapping C func taking func-pointer callbacks</p>
</li>
<li>
<p>Callback can be pure-C, or arbitrary Python</p>
</li>
<li>
<p><strong>Empower passing in a Python func created at runtime to control behaviour of the underlying C function</strong></p>
</li>
<li>
<p>e.g., wrap <code>qsort</code> from C STL</p>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># declared</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stdlib.h</span><span style="color:#e6db74">&#34;</span>:
    void qsort(void <span style="color:#f92672">*</span>array, size_t count, size_t size,
               int (<span style="color:#f92672">*</span>compare)(const void <span style="color:#f92672">*</span>, const void <span style="color:#f92672">*</span>))
</code></pre></div></li>
<li>
<p>features</p>
<ol>
<li>alloc C array of integers of proper size</li>
<li>convert list of Python integers into C int array</li>
<li>call qsort with proper compare func</li>
<li>convert sorted values back to Python and return</li>
</ol>
</li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># func declaration</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stdlib.h</span><span style="color:#e6db74">&#34;</span>:
    void <span style="color:#f92672">*</span>malloc(size_t size)
    void free(void <span style="color:#f92672">*</span>ptr)
        
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pyqsort</span>(list x):
    <span style="color:#66d9ef">cdef</span>:
        int <span style="color:#f92672">*</span>array
        int i, N
            
    <span style="color:#75715e"># Alloc C array</span>
    N <span style="color:#f92672">=</span> len(x)
    array <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>int<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>malloc(sizeof(int) <span style="color:#f92672">*</span> N)
    <span style="color:#66d9ef">if</span> array <span style="color:#f92672">==</span> NULL:
        <span style="color:#66d9ef">raise</span> MemoryEffor(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Unable to allocate array.</span><span style="color:#e6db74">&#34;</span>)
            
    <span style="color:#75715e"># Fill C array with Python int</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(N):
        array[i] <span style="color:#f92672">=</span> x[i]
            
    <span style="color:#75715e"># qsort array....</span>
        
    <span style="color:#75715e"># Convert back to Python and free C array</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(N):
        x[i] <span style="color:#f92672">=</span> array[i]
    free(array)
        
<span style="color:#75715e"># set up compare callback</span>
<span style="color:#75715e"># standard sort</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">int_compare</span>(const void <span style="color:#f92672">*</span>a, const void <span style="color:#f92672">*</span>b):
    <span style="color:#75715e"># convert void pointer args into C int</span>
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ia</span>, <span style="color:#a6e22e">ib</span>
    <span style="color:#75715e"># dereference pointer via indexing 0</span>
    ia <span style="color:#f92672">=</span> (<span style="color:#f92672">&lt;</span>int<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>a)[<span style="color:#ae81ff">0</span>]
    ib <span style="color:#f92672">=</span> (<span style="color:#f92672">&lt;</span>int<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>b)[<span style="color:#ae81ff">0</span>]
    <span style="color:#75715e"># return signed value</span>
    <span style="color:#66d9ef">return</span> ia <span style="color:#f92672">-</span> ib
    
<span style="color:#75715e"># put in qsort array...</span>
    
qsort(<span style="color:#f92672">&lt;</span>void<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>array, <span style="color:#f92672">&lt;</span>size_t<span style="color:#f92672">&gt;</span>N, sizeof(int), int_compare)
    
<span style="color:#75715e"># works but static, expand by allowing reverse-sorting array by negating return value of int_compare:</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">reverse_int_compare</span>(const void <span style="color:#f92672">*</span>a, const void <span style="color:#f92672">*</span>b):
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>int_compare(a, b)
    
<span style="color:#75715e"># add a ctypedef to make working with callback easier</span>
    
<span style="color:#66d9ef">ctypedef</span> int (<span style="color:#f92672">*</span>qsort_cmp)(const void <span style="color:#f92672">*</span>, const void <span style="color:#f92672">*</span>)
    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pyqsort</span>(list x, reverse<span style="color:#f92672">=</span>False):
    <span style="color:#75715e"># ...</span>
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">qsort_cmp</span> <span style="color:#a6e22e">cmp_callback</span>
        
    <span style="color:#75715e"># Select appropriate callback</span>
    <span style="color:#66d9ef">if</span> reverse:
        cmp_callback <span style="color:#f92672">=</span> reverse_int_compare
    <span style="color:#66d9ef">else</span>:
        cmp_callback <span style="color:#f92672">=</span> int_compare
            
    <span style="color:#75715e"># qsort the array ....</span>
    qsort(<span style="color:#f92672">&lt;</span>void<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>array, <span style="color:#f92672">&lt;</span>size_t<span style="color:#f92672">&gt;</span>N, sizeof(int), cmp_callback)
        
    <span style="color:#75715e"># ...</span>
</code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># use</span>
import pyximport; pyximport.install<span style="color:#f92672">(</span><span style="color:#f92672">)</span>
    
from pyqsort improt pyqsort
    
from random import suffle
inlist <span style="color:#f92672">=</span> range<span style="color:#f92672">(</span>10<span style="color:#f92672">)</span>; shuffle<span style="color:#f92672">(</span>inlist<span style="color:#f92672">)</span>
    
pyqsort<span style="color:#f92672">(</span>inlist, reverse<span style="color:#f92672">=</span>True<span style="color:#f92672">)</span>
</code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># more control, allow passing own Python comparison func</span>
<span style="color:#75715e"># C callback has to call Python callback, converting arg between C types and Python types</span>
<span style="color:#75715e"># use a module-global Python object, py_cmp, to store Python func, allow for setting Python callback at runtime, and C callback wrapper can access it when needed</span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">object</span> <span style="color:#a6e22e">py_cmp</span> <span style="color:#f92672">=</span> None
    
<span style="color:#75715e"># qsort expects C func, have to create a callback wrapper cdef matching compare func pointer signature and calling py_cmp </span>
    
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">py_cmp_wrapper</span>(const void <span style="color:#f92672">*</span>a, const void <span style="color:#f92672">*</span>b):
    <span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ia</span>, <span style="color:#a6e22e">ib</span>
    ia <span style="color:#f92672">=</span> (<span style="color:#f92672">&lt;</span>int<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>a)[<span style="color:#ae81ff">0</span>]
    ib <span style="color:#f92672">=</span> (<span style="color:#f92672">&lt;</span>int<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>b)[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">return</span> py_cmp(ia, ib)
    
<span style="color:#75715e"># inside py_cmp_wrapper, must cast void pointer arg to int pointers, dereference them to extract value integers, pass to py_cmp</span>
<span style="color:#75715e"># cython will auto-convert C integers to Python int, hence return value will be converted to C int</span>
    
<span style="color:#75715e"># reverse version</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">reverse_py_cmp_wrapper</span>(const void <span style="color:#f92672">*</span>a, const void <span style="color:#f92672">*</span>b):
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>py_cmp_wrapper(a, b)
    
<span style="color:#75715e"># final logic over 4 callbacks</span>
    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pyqsort</span>(list x, cmp<span style="color:#f92672">=</span>None, reverse<span style="color:#f92672">=</span>False):
    <span style="color:#66d9ef">global</span> py_cmp
    <span style="color:#75715e"># ...</span>
        
    <span style="color:#75715e"># set up cmp callback</span>
    <span style="color:#66d9ef">if</span> cmp <span style="color:#f92672">and</span> reverse:
        py_cmp <span style="color:#f92672">=</span> cmp
        cmp_callback <span style="color:#f92672">=</span> reverse_py_cmp_wrapper
    <span style="color:#66d9ef">elif</span> cmp <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> reverse:
        py_cmp <span style="color:#f92672">=</span> cmp
        cmp_callback <span style="color:#f92672">=</span> py_cmp_wrapper
    <span style="color:#66d9ef">elif</span> reverse:
        cmp_callback <span style="color:#f92672">=</span> reverse_int_compare
    <span style="color:#66d9ef">else</span>:
        cmp_callback <span style="color:#f92672">=</span> int_compare
            
    <span style="color:#75715e"># qsort the array ...</span>
    qsort(<span style="color:#f92672">&lt;</span>void<span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span>array, <span style="color:#f92672">&lt;</span>size_t<span style="color:#f92672">&gt;</span>N, sizeof(int), cmp_callback)
</code></pre></div></li>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># user defined sort</span>
def cmp<span style="color:#f92672">(</span>a, b<span style="color:#f92672">)</span>:
    <span style="color:#66d9ef">return</span> abs<span style="color:#f92672">(</span>a<span style="color:#f92672">)</span> - abs<span style="color:#f92672">(</span>b<span style="color:#f92672">)</span>
    	
pyqsort<span style="color:#f92672">(</span>a, cmp<span style="color:#f92672">=</span>cmp<span style="color:#f92672">)</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="callbacks-and-exception-propagation">Callbacks and Exception Propagation</h3>
<ul>
<li>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython" data-lang="cython"><span style="color:#75715e"># update qsort declaration to allow exception callback</span>
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stdlib.h</span><span style="color:#e6db74">&#34;</span>:
    void qsort(void <span style="color:#f92672">*</span>array, size_t count, size_t size,
               int (<span style="color:#f92672">*</span>compare)(const void <span style="color:#f92672">*</span>, const void <span style="color:#f92672">*</span>) <span style="color:#66d9ef">except</span> <span style="color:#f92672">*</span>)
      
<span style="color:#75715e"># also adding except * clause to ctypedef and all callbacks</span>
  
<span style="color:#66d9ef">ctypedef</span> int (<span style="color:#f92672">*</span>qsort_cmp)(const void <span style="color:#f92672">*</span>, const void <span style="color:#f92672">*</span>) <span style="color:#66d9ef">except</span> <span style="color:#f92672">*</span>
  
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">int_compare</span>(const void <span style="color:#f92672">*</span>a, const void <span style="color:#f92672">*</span>b) <span style="color:#66d9ef">except</span> <span style="color:#f92672">*</span>:
  <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">reverse_int_compare</span>(const void <span style="color:#f92672">*</span>a, const void <span style="color:#f92672">*</span>b) <span style="color:#66d9ef">except</span> <span style="color:#f92672">*</span>:
  <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">py_cmp_wrapper</span>(const void <span style="color:#f92672">*</span>a, const void <span style="color:#f92672">*</span>b) <span style="color:#66d9ef">except</span> <span style="color:#f92672">*</span>:
  <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">cdef</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">reverse_py_cmp_wrapper</span>(const void <span style="color:#f92672">*</span>a, const void <span style="color:#f92672">*</span>b) <span style="color:#66d9ef">except</span> <span style="color:#f92672">*</span>:
  <span style="color:#75715e"># ...</span>
</code></pre></div></li>
</ul>
<h1 id="wrapping-c">Wrapping C++</h1>
<h1 id="chapter-9-profiling-tools">Chapter 9: Profiling Tools</h1>
</div>

        
        <div class="section bottom-menu">
<hr />
<p>


    

    
        
            <a href="/code">
                code
            </a>
        
    
    
        
            &#183; 
            <a href="https://tiny.cc/oceannotebook">
                notebook
            </a>
        
            &#183; 
            <a href="/prose">
                prose
            </a>
        
            &#183; 
            <a href="/gallery">
                gallery
            </a>
        
            &#183; 
            <a href="/qui">
                qui et quoi?
            </a>
        
    
    &#183; 
    <a href="https://oceanbao.github.io/">
        main
    </a>

</p></div>
        

        <div class="section footer">Ocean Ode

<script src="//yihui.name/js/math-code.js"></script>
<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script async src="//yihui.name/js/center-img.js"></script></div>
    </div>
</body>

</html>